version: "3.8"

services:
  # VPN Gateway with Kill Switch - Gluetun uses OpenVPN config
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: media-download-gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=custom
      - OPENVPN_CONFIG=/gluetun/openvpn/client.ovpn
      - KILL_SWITCH=on
      - KILL_SWITCH_ACTIVATE=on
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./gluetun:/gluetun
      - ./openvpn:/gluetun
    networks:
      - media-download-network
    ports:
      - "8880:8080"  # qBittorrent web UI (routed through VPN)
      - "6789:6789"  # NZBGet web UI (routed through VPN)
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/v1/openvpn/status"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Usenet Indexer & Aggregator
  nzbhydra2:
    image: lscr.io/linuxserver/nzbhydra2:latest
    container_name: media-download-nzbhydra2
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
      - SEARCHER=legacy
      - DAEMON_LOGLEVEL=WARN
      - WEB_LOGFILE=true
    volumes:
      - ./nzbhydra2/config:/config
      - ./nzbhydra2/data:/data
    ports:
      - "5076:5076"
    restart: unless-stopped
    networks:
      - media-download-network
    labels:
      - "homepage.group=Media Download"
      - "homepage.name=NZBHydra2"
      - "homepage.href=http://192.168.86.47:5076"
      - "homepage.icon=nzbhydra2.svg"
    # NOT on VPN - only searches, doesn't download

  # Torrent Indexer
  jackett:
    image: lscr.io/linuxserver/jackett:latest
    container_name: media-download-jackett
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./jackett/config:/config
    ports:
      - "9117:9117"
    restart: unless-stopped
    networks:
      - media-download-network
    labels:
      - "homepage.group=Media Download"
      - "homepage.name=Jackett"
      - "homepage.href=http://192.168.86.47:9117"
      - "homepage.icon=jackett.svg"
    # NOT on VPN - only searches, doesn't download

  # Usenet Download Client
  nzbget:
    image: lscr.io/linuxserver/nzbget:latest
    container_name: media-download-nzbget
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./nzbget/config:/config
      - ${DOWNLOAD_PATH:-./downloads/nzb}:/downloads
    network_mode: "service:gluetun"  # Kill switch: routes all traffic through VPN
    depends_on:
      gluetun:
        condition: service_healthy
    restart: unless-stopped

  # Torrent Download Client
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: media-download-qbittorrent
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
      - WEBUI_PORT=8080
    volumes:
      - ./qbittorrent/config:/config
      - ${DOWNLOAD_PATH:-./downloads/torrents}:/downloads
    network_mode: "service:gluetun"  # Kill switch: routes all traffic through VPN
    depends_on:
      gluetun:
        condition: service_healthy
    restart: unless-stopped
    # Note: qBittorrent is behind VPN and accessed by automation services only

  # TV Shows Automation
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: media-download-sonarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./sonarr/config:/config
      - ${MEDIA_PATH:-/jenquist-cloud/archive/entertainment-media/tv}:/tv
      - ${DOWNLOAD_PATH:-./downloads}:/downloads
    ports:
      - "8989:8989"
    restart: unless-stopped
    networks:
      - media-download-network
    labels:
      - "homepage.group=Media Download"
      - "homepage.name=Sonarr"
      - "homepage.href=http://192.168.86.47:8989"
      - "homepage.icon=sonarr.svg"
    depends_on:
      - nzbhydra2
      - jackett

  # Movies Automation
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: media-download-radarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./radarr/config:/config
      - ${MEDIA_PATH:-/jenquist-cloud/archive/entertainment-media/movies}:/movies
      - ${DOWNLOAD_PATH:-./downloads}:/downloads
    ports:
      - "7878:7878"
    restart: unless-stopped
    networks:
      - media-download-network
    labels:
      - "homepage.group=Media Download"
      - "homepage.name=Radarr"
      - "homepage.href=http://192.168.86.47:7878"
      - "homepage.icon=radarr.svg"
    depends_on:
      - nzbhydra2
      - jackett

  # Music Automation
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: media-download-lidarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./lidarr/config:/config
      - ${MEDIA_PATH:-/jenquist-cloud/archive/entertainment-media/Music}:/music
      - ${DOWNLOAD_PATH:-./downloads}:/downloads
    ports:
      - "8686:8686"
    restart: unless-stopped
    networks:
      - media-download-network
    labels:
      - "homepage.group=Media Download"
      - "homepage.name=Lidarr"
      - "homepage.href=http://192.168.86.47:8686"
      - "homepage.icon=lidarr.svg"
    depends_on:
      - nzbhydra2
      - jackett

  # Subtitle Downloader
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: media-download-bazarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./bazarr/config:/config
      - ${MEDIA_PATH:-/jenquist-cloud/archive/entertainment-media}:/media
    ports:
      - "6767:6767"
    restart: unless-stopped
    networks:
      - media-download-network
    labels:
      - "homepage.group=Media Download"
      - "homepage.name=Bazarr"
      - "homepage.href=http://192.168.86.47:6767"
      - "homepage.icon=bazarr.svg"
    depends_on:
      - sonarr
      - radarr
      - lidarr

  # Books Automation (optional)
  readarr:
    image: lscr.io/linuxserver/readarr:develop
    container_name: media-download-readarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./readarr/config:/config
      - ${MEDIA_PATH:-/jenquist-cloud/archive/books}:/books
      - ${DOWNLOAD_PATH:-./downloads}:/downloads
    ports:
      - "8787:8787"
    restart: unless-stopped
    networks:
      - media-download-network
    depends_on:
      - nzbhydra2
      - jackett
    profiles:
      - optional
    labels:
      - "homepage.group=Media Download"
      - "homepage.name=Readarr"
      - "homepage.href=http://192.168.86.47:8787"
      - "homepage.icon=readarr.svg"

  # Usenet Downloader (Alternative)
  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: media-download-sabnzbd
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./sabnzbd/config:/config
      - ${DOWNLOAD_PATH:-./downloads}/sabnzbd:/downloads
    networks:
      - media-download-network
    ports:
      - "8079:8080"
    restart: unless-stopped
    profiles:
      - alternative
    labels:
      - "homepage.group=Media Download"
      - "homepage.name=SABnzbd"
      - "homepage.href=http://192.168.86.47:8079"
      - "homepage.icon=sabnzbd.svg"

networks:
  media-download-network:
    driver: bridge
    # internal: true removed - UI containers need to be accessible from host

