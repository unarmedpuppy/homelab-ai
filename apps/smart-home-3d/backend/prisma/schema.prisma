datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Device definitions and positions
model Device {
  id           String   @id @default(cuid())
  entityId     String   @unique // Home Assistant entity ID
  name         String
  type         String   // light, switch, sensor, thermostat, etc.
  integration  String   @default("home-assistant")
  roomId       String?
  positionX    Float    @default(0)
  positionY    Float    @default(0)
  positionZ    Float    @default(0)
  rotation     Float    @default(0)
  capabilities Json     @default("[]")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  room         Room?    @relation(fields: [roomId], references: [id], onDelete: SetNull)
  states       DeviceState[]

  @@index([entityId])
  @@index([roomId])
  @@index([type])
}

// Device state history for tracking changes over time
model DeviceState {
  id          String   @id @default(cuid())
  deviceId    String
  property    String   // on, brightness, temperature, etc.
  value       Json     // The value of the property
  timestamp   DateTime @default(now())

  device      Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId, timestamp])
  @@index([deviceId, property, timestamp])
  @@index([timestamp])
}

// Floor plan definition
model FloorPlan {
  id        String   @id @default(cuid())
  name      String
  scale     Float    @default(50) // pixels per meter
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  levels    FloorLevel[]
}

// Floor levels (stories)
model FloorLevel {
  id          String   @id @default(cuid())
  floorPlanId String
  name        String
  elevation   Float    @default(0) // height in meters
  sortOrder   Int      @default(0)

  floorPlan   FloorPlan @relation(fields: [floorPlanId], references: [id], onDelete: Cascade)
  rooms       Room[]

  @@index([floorPlanId])
}

// Room definitions
model Room {
  id             String   @id @default(cuid())
  levelId        String
  name           String
  outline        Json     // Array of {x, y} points
  area           Float    @default(0) // square meters
  ceilingHeight  Float    @default(2.7) // meters
  floorThickness Float    @default(0.2)
  walls          Json     @default("[]") // Array of wall definitions
  doors          Json     @default("[]") // Array of door definitions
  windows        Json     @default("[]") // Array of window definitions
  textures       Json     @default("{}") // floor, walls, ceiling texture URLs
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  level          FloorLevel @relation(fields: [levelId], references: [id], onDelete: Cascade)
  devices        Device[]

  @@index([levelId])
}

// User settings
model Settings {
  id        String   @id @default("default")
  theme     String   @default("dark")
  cameraPos Json     @default("[10, 15, 10]")
  viewMode  String   @default("3d")
  updatedAt DateTime @updatedAt
}
