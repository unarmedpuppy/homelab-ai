version: '3.5'
services:
  jellyfin-unlock:
    build:
      context: .
      dockerfile: Dockerfile.unlock
    container_name: jellyfin-unlock
    privileged: true
    environment:
      - ZFS_PATH=${ZFS_PATH}
      - UNLOCK_USER=${UNLOCK_USER:-admin}
      - UNLOCK_PASSWORD_HASH=${UNLOCK_PASSWORD_HASH}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${ZFS_PATH}:${ZFS_PATH}:shared
      - ./unlock-ui.html:/app/unlock-ui.html:ro
      - /dev/zfs:/dev/zfs
      # Mount host's ZFS binaries (adjust path for your system)
      - /usr/sbin/zfs:/usr/sbin/zfs:ro
      - /usr/sbin/zpool:/usr/sbin/zpool:ro
      - /lib64/libzfs.so.6:/lib64/libzfs.so.6:ro
      - /lib64/libzpool.so.5:/lib64/libzpool.so.5:ro
      - /lib64/libnvpair.so.3:/lib64/libnvpair.so.3:ro
      - /lib64/libuutil.so.3:/lib64/libuutil.so.3:ro
      - /lib64/libzfs_core.so.3:/lib64/libzfs_core.so.3:ro
      - /lib64/libzutil.so.3:/lib64/libzutil.so.3:ro
    ports:
      - "8889:8888"
    restart: 'unless-stopped'
    networks:
      - my-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=my-network"
      # HTTPS redirect
      - "traefik.http.middlewares.zfs-unlock-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.zfs-unlock-redirect.middlewares=zfs-unlock-redirect"
      - "traefik.http.routers.zfs-unlock-redirect.rule=Host(`zfs-unlock.server.unarmedpuppy.com`)"
      - "traefik.http.routers.zfs-unlock-redirect.entrypoints=web"
      # Local network access (no auth) - highest priority
      - "traefik.http.routers.zfs-unlock-local.rule=Host(`zfs-unlock.server.unarmedpuppy.com`) && ClientIP(`192.168.86.0/24`)"
      - "traefik.http.routers.zfs-unlock-local.priority=100"
      - "traefik.http.routers.zfs-unlock-local.entrypoints=websecure"
      - "traefik.http.routers.zfs-unlock-local.tls.certresolver=myresolver"
      # External access (requires auth) - lowest priority
      - "traefik.http.routers.zfs-unlock.rule=Host(`zfs-unlock.server.unarmedpuppy.com`)"
      - "traefik.http.routers.zfs-unlock.priority=1"
      - "traefik.http.routers.zfs-unlock.entrypoints=websecure"
      - "traefik.http.routers.zfs-unlock.tls.certresolver=myresolver"
      - "traefik.http.routers.zfs-unlock.tls=true"
      - "traefik.http.routers.zfs-unlock.middlewares=zfs-unlock-auth"
      # Service and auth middleware
      - "traefik.http.services.zfs-unlock.loadbalancer.server.port=8888"
      - "traefik.http.middlewares.zfs-unlock-auth.basicauth.users=unarmedpuppy:$$apr1$$yE.A6vVX$$p7.fpGKw5Unp0UW6H/2c.0"
      - "traefik.http.middlewares.zfs-unlock-auth.basicauth.realm=ZFS-Unlock"
      # Homepage labels
      - "homepage.group=Services"
      - "homepage.name=ZFS Authenticator"
      - "homepage.icon=si-redhat"
      - "homepage.href=https://zfs-unlock.server.unarmedpuppy.com"

networks:
  my-network:
    external: true

