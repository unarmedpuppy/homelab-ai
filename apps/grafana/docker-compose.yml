version: "2"

# Auto-start configuration: set to false to disable this app from auto-starting
x-enabled: true

services:

  loki:
    # image: grafana/loki:latest
    image: harbor.server.unarmedpuppy.com/docker-hub/grafana/loki:latest
    hostname: loki
    container_name: loki
    volumes:
      - ./data/loki:/etc/loki # place loki-config.yml
    ports:
      - "127.0.0.1:3100:3100"
    restart: unless-stopped
    user: 1000:1000
    command: -config.file=/etc/loki/loki-config.yml  
    networks:
      - my-network

  promtail:
    # image: grafana/promtail:latest
    image: harbor.server.unarmedpuppy.com/docker-hub/grafana/promtail:latest
    container_name: promtail
    depends_on:
      - loki
    hostname: promtail
    volumes:
      - /var/log:/var/log:ro # let promtail access the docker host's log files
      - ./data/promtail:/etc/promtail # place promtail-config.yml
      #- ${DOCKER_VOLUME_STORAGE:-/mnt/docker-volumes}/traefik/logs:/var/log/traefik # let promtail access your traefik reverse logs
    restart: unless-stopped
    command: -config.file=/etc/promtail/promtail-config.yml
    networks:
      - my-network

  influxdb:
    # image: influxdb:1.8.10
    image: harbor.server.unarmedpuppy.com/docker-hub/library/influxdb:1.8.10
    container_name: influxdb
    hostname: influxdb
    restart: unless-stopped
    ports:
      - 8086:8086
    volumes:
      - ./data/influxdb/data:/var/lib/influxdb
      - ./data/influxdb/influxdb.conf:/etc/influxdb/influxdb.conf:ro # place infuxdb.conf
      - ./data/influxdb/init:/docker-entrypoint-initdb.d # place create-database.iql for database init
    environment:
      - INFLUXDB_DB=telegrafuser
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=SuperDuperAdminPW
    networks:
      - my-network

  telegraf:
    # image: telegraf:latest
    image: harbor.server.unarmedpuppy.com/docker-hub/library/telegraf:latest
    restart: unless-stopped
    user: telegraf:994 # see: https://www.influxdata.com/blog/docker-run-telegraf-as-non-root/
    container_name: telegraf
    hostname: telegraf
    dns:
      - 1.1.1.1
      - 8.8.8.8
    ports:
      - 9126:9126
    depends_on:
      - influxdb
    volumes:
      - ./data/telegraf:/etc/telegraf # place telegraf.conf
      - /:/hostfs:ro
      - /etc:/hostfs/etc:ro
      - /proc:/hostfs/proc:ro
      - /sys:/hostfs/sys:ro
      - /var/run/utmp:/var/run/utmp:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - HOST_ETC=/hostfs/etc
      - HOST_PROC=/hostfs/proc
      - HOST_SYS=/hostfs/sys
      - HOST_MOUNT_PREFIX=/hostfs
    networks:
      - my-network

  prometheus:
    # image: prom/prometheus:v2.21.0
    image: harbor.server.unarmedpuppy.com/docker-hub/prom/prometheus:v2.21.0
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    command:
      - --web.enable-lifecycle
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
    networks:
      - my-network

  grafana:
    container_name: grafana
    hostname: grafana
    user: ${UID}:${GID}
    depends_on:
      - influxdb
      - loki
      - promtail
      - prometheus
    # image: grafana/grafana:latest
    image: harbor.server.unarmedpuppy.com/docker-hub/grafana/grafana:latest
    restart: unless-stopped
    environment:
      - GF_SERVER_ROOT_URL=https://grafana.server.unarmedpuppy.com # optional
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./config/provisioning:/etc/grafana/provisioning
      - ./config/dashboards:/var/lib/grafana/dashboards
    ports:
      - 3010:3000
    networks:
      - my-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=my-network"
      # HTTPS redirect
      - "traefik.http.middlewares.grafana-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.grafana-redirect.middlewares=grafana-redirect"
      - "traefik.http.routers.grafana-redirect.rule=Host(`grafana.server.unarmedpuppy.com`)"
      - "traefik.http.routers.grafana-redirect.entrypoints=web"
      # Local network access (no auth) - highest priority
      - "traefik.http.routers.grafana-local.rule=Host(`grafana.server.unarmedpuppy.com`) && ClientIP(`192.168.86.0/24`)"
      - "traefik.http.routers.grafana-local.priority=100"
      - "traefik.http.routers.grafana-local.entrypoints=websecure"
      - "traefik.http.routers.grafana-local.tls.certresolver=myresolver"
      - "traefik.http.routers.grafana-local.service=grafana"
      # External access (requires auth) - lowest priority
      - "traefik.http.routers.grafana.rule=Host(`grafana.server.unarmedpuppy.com`)"
      - "traefik.http.routers.grafana.priority=1"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=myresolver"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.routers.grafana.middlewares=grafana-auth"
      - "traefik.http.routers.grafana.service=grafana"
      # Service and auth middleware
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.grafana-auth.basicauth.users=unarmedpuppy:$$apr1$$yE.A6vVX$$p7.fpGKw5Unp0UW6H/2c.0"
      - "traefik.http.middlewares.grafana-auth.basicauth.realm=Grafana"
      # Homepage labels
      - "homepage.group=Infrastructure"
      - "homepage.name=Grafana"
      - "homepage.icon=si-grafana"
      - "homepage.href=https://grafana.server.unarmedpuppy.com/d/sF7d-FHZz122/server?orgId=1&refresh=15m"
      - "homepage.description=Home Server telemetry & metrics"

volumes:
  prometheus_data:

networks:
  my-network:
    external: true
