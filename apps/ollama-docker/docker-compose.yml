version: '3.8'
services:
  app:
    build: .
    ports:
      - 8092:8000
      - 5678:5678
    volumes:
      - .:/code
    command: uvicorn src.main:app --host 0.0.0.0 --port 8092 --reload
    restart: always
    depends_on:
      - ollama
      - ollama-webui
    networks:
      - ollama-docker

  ollama:
    # image: ollama/ollama:latest
    image: harbor.server.unarmedpuppy.com/docker-hub/ollama/ollama:latest
    ports:
      - 7869:11434
    volumes:
      - .:/code
      - ./ollama/ollama:/root/.ollama
    container_name: ollama
    pull_policy: always
    tty: true
    restart: always
    environment:
      - OLLAMA_KEEP_ALIVE=24h
      - OLLAMA_HOST=0.0.0.0
    networks:
      - ollama-docker

  ollama-webui:
    # image: ghcr.io/open-webui/open-webui:main
    image: harbor.server.unarmedpuppy.com/ghcr/open-webui/open-webui:main
    container_name: ollama-webui
    volumes:
      - ./ollama/ollama-webui:/app/backend/data
    depends_on:
      - ollama
    ports:
      - 8091:8080
    environment: # https://docs.openwebui.com/getting-started/env-configuration#default_models
      - OLLAMA_BASE_URLS=http://host.docker.internal:7869 #comma separated ollama hosts
      - ENV=dev
      - WEBUI_AUTH=False
      - WEBUI_NAME=valiantlynx AI
      - WEBUI_URL=http://localhost:8091
      - WEBUI_SECRET_KEY=t0p-s3cr3t
    extra_hosts:
      - host.docker.internal:host-gateway
    restart: unless-stopped
    networks:
      - ollama-docker
      - my-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=my-network"
      # HTTPS redirect
      - "traefik.http.middlewares.ollama-webui-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.ollama-webui-redirect.middlewares=ollama-webui-redirect"
      - "traefik.http.routers.ollama-webui-redirect.rule=Host(`ollama.server.unarmedpuppy.com`)"
      - "traefik.http.routers.ollama-webui-redirect.entrypoints=web"
      # Local network access (no auth) - highest priority
      - "traefik.http.routers.ollama-webui-local.rule=Host(`ollama.server.unarmedpuppy.com`) && ClientIP(`192.168.86.0/24`)"
      - "traefik.http.routers.ollama-webui-local.priority=100"
      - "traefik.http.routers.ollama-webui-local.entrypoints=websecure"
      - "traefik.http.routers.ollama-webui-local.tls.certresolver=myresolver"
      # External access (requires auth) - lowest priority
      - "traefik.http.routers.ollama-webui.rule=Host(`ollama.server.unarmedpuppy.com`)"
      - "traefik.http.routers.ollama-webui.priority=1"
      - "traefik.http.routers.ollama-webui.entrypoints=websecure"
      - "traefik.http.routers.ollama-webui.tls.certresolver=myresolver"
      - "traefik.http.routers.ollama-webui.tls=true"
      - "traefik.http.routers.ollama-webui.middlewares=ollama-webui-auth"
      # Service and auth middleware
      - "traefik.http.services.ollama-webui.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.ollama-webui-auth.basicauth.users=unarmedpuppy:$$apr1$$yE.A6vVX$$p7.fpGKw5Unp0UW6H/2c.0"
      - "traefik.http.middlewares.ollama-webui-auth.basicauth.realm=Ollama-WebUI"
      # Homepage labels
      - "homepage.group=AI & Machine Learning"
      - "homepage.name=Ollama WebUI"
      - "homepage.icon=si-ollama"
      - "homepage.href=https://ollama.server.unarmedpuppy.com"
      - "homepage.description=Ollama AI model interface"

networks:
  ollama-docker:
    external: false
  my-network:
    external: true
  
