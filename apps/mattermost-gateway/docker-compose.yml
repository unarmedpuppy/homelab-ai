x-enabled: true

services:
  mattermost-gateway:
    build: .
    image: harbor.server.unarmedpuppy.com/library/mattermost-gateway:latest
    container_name: mattermost-gateway
    restart: unless-stopped
    environment:
      - TZ=America/Chicago
      - MATTERMOST_URL=${MATTERMOST_URL:-mattermost.server.unarmedpuppy.com}
      - MATTERMOST_SCHEME=${MATTERMOST_SCHEME:-https}
      - MATTERMOST_PORT=${MATTERMOST_PORT:-443}
      - MATTERMOST_BOT_TAYNE_TOKEN=${MATTERMOST_BOT_TAYNE_TOKEN:-}
      - MATTERMOST_BOT_MONITOR_TOKEN=${MATTERMOST_BOT_MONITOR_TOKEN:-}
      - MATTERMOST_BOT_TRADING_TOKEN=${MATTERMOST_BOT_TRADING_TOKEN:-}
      - GATEWAY_PORT=${GATEWAY_PORT:-8000}
      - GATEWAY_LOG_LEVEL=${GATEWAY_LOG_LEVEL:-INFO}
      - DEFAULT_CHANNEL=${DEFAULT_CHANNEL:-town-square}
      - LOCAL_AI_URL=${LOCAL_AI_URL:-http://local-ai-router:8000}
      - LOCAL_AI_API_KEY=${LOCAL_AI_API_KEY:-}
    ports:
      - "8011:8000"
    networks:
      - my-network
    labels:
      - "traefik.enable=true"
      # HTTPS redirect
      - "traefik.http.middlewares.mattermost-gateway-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.mattermost-gateway-redirect.middlewares=mattermost-gateway-redirect"
      - "traefik.http.routers.mattermost-gateway-redirect.rule=Host(`mattermost-gateway.server.unarmedpuppy.com`)"
      - "traefik.http.routers.mattermost-gateway-redirect.entrypoints=web"
      # Main router
      - "traefik.http.routers.mattermost-gateway.rule=Host(`mattermost-gateway.server.unarmedpuppy.com`)"
      - "traefik.http.routers.mattermost-gateway.entrypoints=websecure"
      - "traefik.http.routers.mattermost-gateway.tls.certresolver=myresolver"
      - "traefik.http.services.mattermost-gateway.loadbalancer.server.port=8000"
      # Homepage labels
      - "homepage.group=Infrastructure"
      - "homepage.name=Mattermost Gateway"
      - "homepage.icon=mdi-api"
      - "homepage.href=https://mattermost-gateway.server.unarmedpuppy.com/health"
      - "homepage.description=Bot message gateway for Mattermost"

networks:
  my-network:
    external: true
