version: "3.9"
services:
  bot:
    build: .
    image: trading-bot:latest
    container_name: trading-bot
    environment:
      # Database
      DATABASE_URL: sqlite:////data/trading_bot.db
      
      # Data Provider API Keys
      ALPHA_VANTAGE_API_KEY: ${ALPHA_VANTAGE_API_KEY:-}
      POLYGON_API_KEY: ${POLYGON_API_KEY:-}
      UW_API_KEY: ${UW_API_KEY:-}
      
      # Twitter/X API Configuration
      TWITTER_API_KEY: ${TWITTER_API_KEY:-}
      TWITTER_API_SECRET: ${TWITTER_API_SECRET:-}
      TWITTER_BEARER_TOKEN: ${TWITTER_BEARER_TOKEN:-}
      TWITTER_ACCESS_TOKEN: ${TWITTER_ACCESS_TOKEN:-}
      TWITTER_ACCESS_TOKEN_SECRET: ${TWITTER_ACCESS_TOKEN_SECRET:-}
      TWITTER_RATE_LIMIT_ENABLED: ${TWITTER_RATE_LIMIT_ENABLED:-true}
      TWITTER_CACHE_TTL: ${TWITTER_CACHE_TTL:-300}
      TWITTER_MAX_RESULTS: ${TWITTER_MAX_RESULTS:-100}
      TWITTER_SEARCH_LANGUAGE: ${TWITTER_SEARCH_LANGUAGE:-en}
      
      # Reddit API Configuration
      REDDIT_CLIENT_ID: ${REDDIT_CLIENT_ID:-}
      REDDIT_CLIENT_SECRET: ${REDDIT_CLIENT_SECRET:-}
      REDDIT_USER_AGENT: ${REDDIT_USER_AGENT:-TradingBot/1.0 by /u/tradingbot}
      REDDIT_USERNAME: ${REDDIT_USERNAME:-}
      REDDIT_PASSWORD: ${REDDIT_PASSWORD:-}
      REDDIT_RATE_LIMIT_ENABLED: ${REDDIT_RATE_LIMIT_ENABLED:-true}
      REDDIT_CACHE_TTL: ${REDDIT_CACHE_TTL:-300}
      REDDIT_MAX_RESULTS: ${REDDIT_MAX_RESULTS:-100}
      REDDIT_SUBREDDITS: ${REDDIT_SUBREDDITS:-wallstreetbets,stocks,investing}
      REDDIT_MIN_SCORE: ${REDDIT_MIN_SCORE:-0}
      REDDIT_MIN_LENGTH: ${REDDIT_MIN_LENGTH:-10}
      
      # StockTwits API Configuration
      STOCKTWITS_API_TOKEN: ${STOCKTWITS_API_TOKEN:-}
      STOCKTWITS_RATE_LIMIT_ENABLED: ${STOCKTWITS_RATE_LIMIT_ENABLED:-true}
      STOCKTWITS_CACHE_TTL: ${STOCKTWITS_CACHE_TTL:-300}
      STOCKTWITS_MAX_RESULTS: ${STOCKTWITS_MAX_RESULTS:-30}
      STOCKTWITS_ENABLE_VADER: ${STOCKTWITS_ENABLE_VADER:-false}
      
      # News Provider Configuration
      NEWS_CACHE_TTL: ${NEWS_CACHE_TTL:-300}
      NEWS_RATE_LIMIT_REQUESTS_PER_MINUTE: ${NEWS_RATE_LIMIT_REQUESTS_PER_MINUTE:-60}
      NEWS_MIN_ARTICLE_LENGTH: ${NEWS_MIN_ARTICLE_LENGTH:-100}
      NEWS_RELEVANCE_THRESHOLD: ${NEWS_RELEVANCE_THRESHOLD:-0.3}
      NEWS_SOURCES: ${NEWS_SOURCES:-yahoo,reuters,marketwatch,cnbc}
      NEWS_ENABLE_FULL_ARTICLE_PARSING: ${NEWS_ENABLE_FULL_ARTICLE_PARSING:-true}
      NEWS_MAX_ARTICLES_PER_FETCH: ${NEWS_MAX_ARTICLES_PER_FETCH:-50}
      
      # Google Trends Configuration
      GOOGLE_TRENDS_ENABLED: ${GOOGLE_TRENDS_ENABLED:-true}
      GOOGLE_TRENDS_CACHE_TTL: ${GOOGLE_TRENDS_CACHE_TTL:-3600}
      GOOGLE_TRENDS_RATE_LIMIT_ENABLED: ${GOOGLE_TRENDS_RATE_LIMIT_ENABLED:-true}
      GOOGLE_TRENDS_MIN_REQUEST_INTERVAL: ${GOOGLE_TRENDS_MIN_REQUEST_INTERVAL:-1.0}
      GOOGLE_TRENDS_GEO: ${GOOGLE_TRENDS_GEO:-US}
      
      # Analyst Ratings Configuration
      ANALYST_RATINGS_ENABLED: ${ANALYST_RATINGS_ENABLED:-true}
      ANALYST_RATINGS_CACHE_TTL: ${ANALYST_RATINGS_CACHE_TTL:-3600}
      ANALYST_RATINGS_USE_PRICE_TARGET_WEIGHTING: ${ANALYST_RATINGS_USE_PRICE_TARGET_WEIGHTING:-true}
      
      # Insider Trading & Institutional Holdings Configuration
      INSIDER_TRADING_ENABLED: ${INSIDER_TRADING_ENABLED:-true}
      INSIDER_TRADING_CACHE_TTL: ${INSIDER_TRADING_CACHE_TTL:-3600}
      INSIDER_TRADING_INSIDER_WEIGHT: ${INSIDER_TRADING_INSIDER_WEIGHT:-0.6}
      INSIDER_TRADING_INSTITUTIONAL_WEIGHT: ${INSIDER_TRADING_INSTITUTIONAL_WEIGHT:-0.4}
      INSIDER_TRADING_TIMEOUT_SECONDS: ${INSIDER_TRADING_TIMEOUT_SECONDS:-10}
      INSIDER_TRADING_MAX_RETRIES: ${INSIDER_TRADING_MAX_RETRIES:-3}
      INSIDER_TRADING_RETRY_BACKOFF_FACTOR: ${INSIDER_TRADING_RETRY_BACKOFF_FACTOR:-1.5}
      INSIDER_TRADING_RATE_LIMIT_REQUESTS_PER_MINUTE: ${INSIDER_TRADING_RATE_LIMIT_REQUESTS_PER_MINUTE:-60}
      
      # Interactive Brokers
      IBKR_HOST: host.docker.internal
      IBKR_PORT: 7497
      IBKR_CLIENT_ID: 9
      
      # API Configuration
      API_HOST: 0.0.0.0
      API_PORT: 8000
      API_DEBUG: false
      
      # Logging
      LOG_LEVEL: INFO
      ENVIRONMENT: production
      
      # Metrics Configuration
      METRICS_ENABLED: ${METRICS_ENABLED:-true}
      METRICS_PATH: ${METRICS_PATH:-/metrics}
      METRICS_ENABLE_INTERNAL_METRICS: ${METRICS_ENABLE_INTERNAL_METRICS:-true}
    ports:
      - "8000:8000"
    volumes:
      - ./data:/data
      - ./logs:/app/logs
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - trading-bot-network

  prometheus:
    image: prom/prometheus:latest
    container_name: trading-bot-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    restart: unless-stopped
    networks:
      - trading-bot-network
    depends_on:
      - bot

  grafana:
    image: grafana/grafana:latest
    container_name: trading-bot-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/etc/grafana/dashboards:ro
    ports:
      - "3000:3000"
    restart: unless-stopped
    networks:
      - trading-bot-network
    depends_on:
      - prometheus

  alertmanager:
    image: prom/alertmanager:latest
    container_name: trading-bot-alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9093'
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    ports:
      - "9093:9093"
    restart: unless-stopped
    networks:
      - trading-bot-network
    depends_on:
      - prometheus

networks:
  trading-bot-network:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
  alertmanager-data:
