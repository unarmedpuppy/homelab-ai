version: "3.9"
services:
  # IB Gateway - Interactive Brokers API Gateway
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:stable
    container_name: trading-bot-ib-gateway
    restart: unless-stopped
    environment:
      TWS_USERID: ${IBKR_USERNAME}
      TWS_PASSWORD: ${IBKR_PASSWORD}
      TRADING_MODE: ${IBKR_TRADING_MODE:-paper}  # 'paper' or 'live'
      TWS_ACCEPT_INCOMING: "accept"
      READ_ONLY_API: ${IBKR_READ_ONLY:-no}  # 'yes' for read-only, 'no' for trading
      VNC_SERVER_PASSWORD: ${VNC_PASSWORD:-}  # Optional: set for VNC access
      TWS_SETTINGS_PATH: /home/ibgateway/tws_settings  # Persist settings here
    ports:
      - "4001:4003"   # Live trading API (socat listens on 4003, relays to internal 4001)
      - "4002:4004"   # Paper trading API (socat listens on 4004, relays to internal 4002)
      - "5900:5900"   # VNC (optional, for debugging)
    volumes:
      - ./ib-gateway-data:/home/ibgateway/tws_settings
    networks:
      - trading-bot-network
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/4004' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # IB Gateway takes time to start
    labels:
      - "homepage.group=Finance & Trading"
      - "homepage.name=IB Gateway"
      - "homepage.icon=si-interactivebrokers"
      - "homepage.description=Interactive Brokers Gateway for API trading"

  bot:
    build: .
    image: trading-bot:latest
    container_name: trading-bot
    environment:
      # Database
      DATABASE_URL: sqlite:////data/trading_bot.db
      
      # Data Provider API Keys
      ALPHA_VANTAGE_API_KEY: ${ALPHA_VANTAGE_API_KEY:-}
      POLYGON_API_KEY: ${POLYGON_API_KEY:-}
      UW_API_KEY: ${UW_API_KEY:-}

      # Unusual Whales Scraper Configuration
      UW_SCRAPER_ENABLED: ${UW_SCRAPER_ENABLED:-true}
      UW_SCRAPER_USERNAME: ${UW_SCRAPER_USERNAME:-}
      UW_SCRAPER_PASSWORD: ${UW_SCRAPER_PASSWORD:-}
      UW_SCRAPER_MARKET_TIDE_INTERVAL: ${UW_SCRAPER_MARKET_TIDE_INTERVAL:-30}
      UW_SCRAPER_TICKER_FLOW_INTERVAL: ${UW_SCRAPER_TICKER_FLOW_INTERVAL:-60}
      UW_SCRAPER_TICKER_FLOW_SYMBOLS: ${UW_SCRAPER_TICKER_FLOW_SYMBOLS:-SPY,QQQ,AAPL,NVDA,TSLA}
      
      # Twitter/X API Configuration
      TWITTER_API_KEY: ${TWITTER_API_KEY:-}
      TWITTER_API_SECRET: ${TWITTER_API_SECRET:-}
      TWITTER_BEARER_TOKEN: ${TWITTER_BEARER_TOKEN:-}
      TWITTER_ACCESS_TOKEN: ${TWITTER_ACCESS_TOKEN:-}
      TWITTER_ACCESS_TOKEN_SECRET: ${TWITTER_ACCESS_TOKEN_SECRET:-}
      TWITTER_RATE_LIMIT_ENABLED: ${TWITTER_RATE_LIMIT_ENABLED:-true}
      TWITTER_CACHE_TTL: ${TWITTER_CACHE_TTL:-300}
      TWITTER_MAX_RESULTS: ${TWITTER_MAX_RESULTS:-100}
      TWITTER_SEARCH_LANGUAGE: ${TWITTER_SEARCH_LANGUAGE:-en}
      
      # Reddit API Configuration
      REDDIT_CLIENT_ID: ${REDDIT_CLIENT_ID:-}
      REDDIT_CLIENT_SECRET: ${REDDIT_CLIENT_SECRET:-}
      REDDIT_USER_AGENT: ${REDDIT_USER_AGENT:-TradingBot/1.0 by /u/tradingbot}
      REDDIT_USERNAME: ${REDDIT_USERNAME:-}
      REDDIT_PASSWORD: ${REDDIT_PASSWORD:-}
      REDDIT_RATE_LIMIT_ENABLED: ${REDDIT_RATE_LIMIT_ENABLED:-true}
      REDDIT_CACHE_TTL: ${REDDIT_CACHE_TTL:-300}
      REDDIT_MAX_RESULTS: ${REDDIT_MAX_RESULTS:-100}
      REDDIT_SUBREDDITS: ${REDDIT_SUBREDDITS:-wallstreetbets,stocks,investing}
      REDDIT_MIN_SCORE: ${REDDIT_MIN_SCORE:-0}
      REDDIT_MIN_LENGTH: ${REDDIT_MIN_LENGTH:-10}
      
      # StockTwits API Configuration
      STOCKTWITS_API_TOKEN: ${STOCKTWITS_API_TOKEN:-}
      STOCKTWITS_RATE_LIMIT_ENABLED: ${STOCKTWITS_RATE_LIMIT_ENABLED:-true}
      STOCKTWITS_CACHE_TTL: ${STOCKTWITS_CACHE_TTL:-300}
      STOCKTWITS_MAX_RESULTS: ${STOCKTWITS_MAX_RESULTS:-30}
      STOCKTWITS_ENABLE_VADER: ${STOCKTWITS_ENABLE_VADER:-false}
      
      # News Provider Configuration
      NEWS_CACHE_TTL: ${NEWS_CACHE_TTL:-300}
      NEWS_RATE_LIMIT_REQUESTS_PER_MINUTE: ${NEWS_RATE_LIMIT_REQUESTS_PER_MINUTE:-60}
      NEWS_MIN_ARTICLE_LENGTH: ${NEWS_MIN_ARTICLE_LENGTH:-100}
      NEWS_RELEVANCE_THRESHOLD: ${NEWS_RELEVANCE_THRESHOLD:-0.3}
      NEWS_SOURCES: ${NEWS_SOURCES:-yahoo,reuters,marketwatch,cnbc}
      NEWS_ENABLE_FULL_ARTICLE_PARSING: ${NEWS_ENABLE_FULL_ARTICLE_PARSING:-true}
      NEWS_MAX_ARTICLES_PER_FETCH: ${NEWS_MAX_ARTICLES_PER_FETCH:-50}
      
      # Google Trends Configuration
      GOOGLE_TRENDS_ENABLED: ${GOOGLE_TRENDS_ENABLED:-true}
      GOOGLE_TRENDS_CACHE_TTL: ${GOOGLE_TRENDS_CACHE_TTL:-3600}
      GOOGLE_TRENDS_RATE_LIMIT_ENABLED: ${GOOGLE_TRENDS_RATE_LIMIT_ENABLED:-true}
      GOOGLE_TRENDS_MIN_REQUEST_INTERVAL: ${GOOGLE_TRENDS_MIN_REQUEST_INTERVAL:-1.0}
      GOOGLE_TRENDS_GEO: ${GOOGLE_TRENDS_GEO:-US}
      
      # Analyst Ratings Configuration
      ANALYST_RATINGS_ENABLED: ${ANALYST_RATINGS_ENABLED:-true}
      ANALYST_RATINGS_CACHE_TTL: ${ANALYST_RATINGS_CACHE_TTL:-3600}
      ANALYST_RATINGS_USE_PRICE_TARGET_WEIGHTING: ${ANALYST_RATINGS_USE_PRICE_TARGET_WEIGHTING:-true}
      
      # Insider Trading & Institutional Holdings Configuration
      INSIDER_TRADING_ENABLED: ${INSIDER_TRADING_ENABLED:-true}
      INSIDER_TRADING_CACHE_TTL: ${INSIDER_TRADING_CACHE_TTL:-3600}
      INSIDER_TRADING_INSIDER_WEIGHT: ${INSIDER_TRADING_INSIDER_WEIGHT:-0.6}
      INSIDER_TRADING_INSTITUTIONAL_WEIGHT: ${INSIDER_TRADING_INSTITUTIONAL_WEIGHT:-0.4}
      INSIDER_TRADING_TIMEOUT_SECONDS: ${INSIDER_TRADING_TIMEOUT_SECONDS:-10}
      INSIDER_TRADING_MAX_RETRIES: ${INSIDER_TRADING_MAX_RETRIES:-3}
      INSIDER_TRADING_RETRY_BACKOFF_FACTOR: ${INSIDER_TRADING_RETRY_BACKOFF_FACTOR:-1.5}
      INSIDER_TRADING_RATE_LIMIT_REQUESTS_PER_MINUTE: ${INSIDER_TRADING_RATE_LIMIT_REQUESTS_PER_MINUTE:-60}
      
      # Interactive Brokers - connects to ib-gateway container
      IBKR_HOST: ib-gateway
      IBKR_PORT: ${IBKR_PORT:-4002}  # 4002 for paper, 4001 for live
      IBKR_CLIENT_ID: ${IBKR_CLIENT_ID:-9}
      
      # API Configuration
      API_HOST: 0.0.0.0
      API_PORT: 8000
      API_DEBUG: false
      
      # Logging
      LOG_LEVEL: INFO
      ENVIRONMENT: production
      
      # Metrics Configuration
      METRICS_ENABLED: ${METRICS_ENABLED:-true}
      METRICS_PATH: ${METRICS_PATH:-/metrics}
      METRICS_ENABLE_INTERNAL_METRICS: ${METRICS_ENABLE_INTERNAL_METRICS:-true}
    ports:
      - "8021:8000"
    volumes:
      - ./data:/data
      - ./logs:/app/logs
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - trading-bot-network
    # depends_on:
    #   ib-gateway:
    #     condition: service_healthy
    labels:
      - "homepage.group=Finance & Trading"
      - "homepage.name=Trading Dashboard"
      - "homepage.icon=si-tradingview"
      - "homepage.href=http://192.168.86.47:8021/dashboard"
      - "homepage.description=Trading bot dashboard with signals, debates, and portfolio"

  prometheus:
    image: prom/prometheus:latest
    container_name: trading-bot-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9091:9090"
    restart: unless-stopped
    networks:
      - trading-bot-network
    depends_on:
      - bot
    labels:
      - "homepage.group=Finance & Trading"
      - "homepage.name=Prometheus"
      - "homepage.icon=si-prometheus"
      - "homepage.href=http://192.168.86.47:9091"
      - "homepage.description=Prometheus metrics for trading bot"

  grafana:
    image: grafana/grafana:latest
    container_name: trading-bot-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3002
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/etc/grafana/dashboards:ro
    ports:
      - "3002:3000"
    restart: unless-stopped
    networks:
      - trading-bot-network
    depends_on:
      - prometheus
    labels:
      - "homepage.group=Finance & Trading"
      - "homepage.name=Grafana"
      - "homepage.icon=si-grafana"
      - "homepage.href=http://192.168.86.47:3002"
      - "homepage.description=Grafana dashboards for trading bot"

  alertmanager:
    image: prom/alertmanager:latest
    container_name: trading-bot-alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9094'
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    ports:
      - "9094:9093"
    restart: unless-stopped
    networks:
      - trading-bot-network
    depends_on:
      - prometheus
    labels:
      - "homepage.group=Finance & Trading"
      - "homepage.name=Alertmanager"
      - "homepage.icon=si-bell"
      - "homepage.href=http://192.168.86.47:9094"
      - "homepage.description=Alertmanager for trading bot notifications"

networks:
  trading-bot-network:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
  alertmanager-data:
