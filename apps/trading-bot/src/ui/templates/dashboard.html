<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.2s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-2px);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-white text-2xl mr-3"></i>
                    <h1 class="text-white text-xl font-bold">Trading Bot Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white">
                        <span class="text-sm">Status:</span>
                        <span id="connection-status" class="ml-2 px-2 py-1 bg-green-500 rounded-full text-xs">
                            <i class="fas fa-circle mr-1"></i>Connected
                        </span>
                    </div>
                    <button id="settings-btn" class="text-white hover:text-gray-200">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-wallet text-green-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Portfolio Value</p>
                        <p id="portfolio-value" class="text-2xl font-semibold text-gray-900">$100,000</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-chart-line text-blue-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Today's P&L</p>
                        <p id="daily-pnl" class="text-2xl font-semibold text-green-600">+$1,250</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-percentage text-purple-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Win Rate</p>
                        <p id="win-rate" class="text-2xl font-semibold text-gray-900">68.5%</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exchange-alt text-orange-500 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Active Trades</p>
                        <p id="active-trades" class="text-2xl font-semibold text-gray-900">3</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Trading Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-900">Trading Panel</h2>
                        <div class="flex space-x-2">
                            <button id="paper-trading-btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                                <i class="fas fa-play mr-2"></i>Paper Trading
                            </button>
                            <button id="live-trading-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 disabled:opacity-50" disabled>
                                <i class="fas fa-play mr-2"></i>Live Trading
                            </button>
                        </div>
                    </div>

                    <!-- Symbol Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Symbol</label>
                        <div class="flex space-x-4">
                            <select id="symbol-select" class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="AAPL">AAPL - Apple Inc.</option>
                                <option value="MSFT">MSFT - Microsoft Corp.</option>
                                <option value="NVDA">NVDA - NVIDIA Corp.</option>
                                <option value="GOOGL">GOOGL - Alphabet Inc.</option>
                                <option value="AMZN">AMZN - Amazon.com Inc.</option>
                            </select>
                            <button id="refresh-price" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Current Price Display -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 id="current-symbol" class="text-lg font-semibold">AAPL</h3>
                                <p id="current-price" class="text-3xl font-bold text-gray-900">$150.25</p>
                            </div>
                            <div class="text-right">
                                <p id="price-change" class="text-lg font-semibold text-green-600">+$0.15</p>
                                <p id="price-change-pct" class="text-sm text-green-600">+0.10%</p>
                            </div>
                        </div>
                    </div>

                    <!-- Trading Parameters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                            <input type="number" id="quantity" value="10" min="1" max="1000" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Entry Threshold (%)</label>
                            <input type="number" id="entry-threshold" value="0.5" min="0.1" max="5" step="0.1"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Take Profit (%)</label>
                            <input type="number" id="take-profit" value="20" min="1" max="100" step="1"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stop Loss (%)</label>
                            <input type="number" id="stop-loss" value="10" min="1" max="50" step="1"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-4">
                        <button id="generate-signal" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 font-medium">
                            <i class="fas fa-brain mr-2"></i>Generate Signal
                        </button>
                        <button id="execute-trade" class="flex-1 px-6 py-3 bg-green-500 text-white rounded-md hover:bg-green-600 font-medium">
                            <i class="fas fa-play mr-2"></i>Execute Trade
                        </button>
                    </div>
                </div>
            </div>

            <!-- Market Data & Signals -->
            <div class="space-y-6">
                <!-- Current Signal -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Signal</h3>
                    <div id="signal-display" class="text-center py-8">
                        <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500">No signal generated</p>
                    </div>
                </div>

                <!-- Recent Trades -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Trades</h3>
                    <div id="recent-trades" class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                            <div>
                                <p class="font-medium">AAPL</p>
                                <p class="text-sm text-gray-500">BUY 10 shares</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-green-600">+$125</p>
                                <p class="text-sm text-gray-500">2m ago</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                            <div>
                                <p class="font-medium">MSFT</p>
                                <p class="text-sm text-gray-500">SELL 5 shares</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-red-600">-$45</p>
                                <p class="text-sm text-gray-500">15m ago</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Portfolio Performance -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Portfolio Performance</h3>
                <canvas id="portfolio-chart" width="400" height="200"></canvas>
            </div>

            <!-- Trade Distribution -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Trade Distribution</h3>
                <canvas id="trade-distribution-chart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- WebSocket Connection -->
    <script>
        class TradingDashboard {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.init();
            }

            init() {
                this.connectWebSocket();
                this.setupEventListeners();
                this.initializeCharts();
                this.startPriceUpdates();
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    this.isConnected = true;
                    this.updateConnectionStatus('Connected', 'green');
                    console.log('WebSocket connected');
                };
                
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
                
                this.ws.onclose = () => {
                    this.isConnected = false;
                    this.updateConnectionStatus('Disconnected', 'red');
                    console.log('WebSocket disconnected');
                    
                    // Reconnect after 5 seconds
                    setTimeout(() => this.connectWebSocket(), 5000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus('Error', 'red');
                };
            }

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'price_update':
                        this.updatePriceData(data.symbols);
                        break;
                    case 'signal':
                        this.displaySignal(data);
                        break;
                    case 'trade_executed':
                        this.addRecentTrade(data);
                        break;
                    case 'pong':
                        console.log('Pong received');
                        break;
                }
            }

            updatePriceData(symbols) {
                const currentSymbol = document.getElementById('symbol-select').value;
                if (symbols[currentSymbol]) {
                    const data = symbols[currentSymbol];
                    document.getElementById('current-price').textContent = `$${data.price.toFixed(2)}`;
                    document.getElementById('price-change').textContent = `${data.change >= 0 ? '+' : ''}$${data.change.toFixed(2)}`;
                    document.getElementById('price-change-pct').textContent = `${data.change_pct >= 0 ? '+' : ''}${data.change_pct.toFixed(2)}%`;
                    
                    // Update color based on change
                    const changeColor = data.change >= 0 ? 'text-green-600' : 'text-red-600';
                    document.getElementById('price-change').className = `text-lg font-semibold ${changeColor}`;
                    document.getElementById('price-change-pct').className = `text-sm ${changeColor}`;
                }
            }

            displaySignal(signalData) {
                const signalDisplay = document.getElementById('signal-display');
                const signalType = signalData.signal_type;
                const confidence = signalData.confidence;
                
                let icon, color, text;
                switch (signalType) {
                    case 'BUY':
                        icon = 'fas fa-arrow-up';
                        color = 'text-green-500';
                        text = 'BUY Signal';
                        break;
                    case 'SELL':
                        icon = 'fas fa-arrow-down';
                        color = 'text-red-500';
                        text = 'SELL Signal';
                        break;
                    default:
                        icon = 'fas fa-minus';
                        color = 'text-gray-500';
                        text = 'HOLD Signal';
                }
                
                signalDisplay.innerHTML = `
                    <i class="${icon} ${color} text-4xl mb-4"></i>
                    <p class="text-xl font-semibold ${color}">${text}</p>
                    <p class="text-sm text-gray-500">Confidence: ${(confidence * 100).toFixed(1)}%</p>
                    <p class="text-sm text-gray-500">Price: $${signalData.price}</p>
                `;
            }

            setupEventListeners() {
                // Symbol selection
                document.getElementById('symbol-select').addEventListener('change', (e) => {
                    document.getElementById('current-symbol').textContent = e.target.value;
                });

                // Generate signal
                document.getElementById('generate-signal').addEventListener('click', () => {
                    this.generateSignal();
                });

                // Execute trade
                document.getElementById('execute-trade').addEventListener('click', () => {
                    this.executeTrade();
                });

                // Refresh price
                document.getElementById('refresh-price').addEventListener('click', () => {
                    this.refreshPrice();
                });
            }

            async generateSignal() {
                const symbol = document.getElementById('symbol-select').value;
                const entryThreshold = parseFloat(document.getElementById('entry-threshold').value) / 100;
                const takeProfit = parseFloat(document.getElementById('take-profit').value) / 100;
                const stopLoss = parseFloat(document.getElementById('stop-loss').value) / 100;
                const quantity = parseInt(document.getElementById('quantity').value);

                try {
                    const response = await fetch('/api/trading/signal', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            symbol,
                            entry_threshold: entryThreshold,
                            take_profit: takeProfit,
                            stop_loss: stopLoss,
                            quantity
                        })
                    });

                    const signal = await response.json();
                    this.displaySignal(signal);
                } catch (error) {
                    console.error('Error generating signal:', error);
                }
            }

            async executeTrade() {
                const symbol = document.getElementById('symbol-select').value;
                const quantity = parseInt(document.getElementById('quantity').value);
                const currentPrice = parseFloat(document.getElementById('current-price').textContent.replace('$', ''));

                try {
                    const response = await fetch('/api/trading/execute', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            symbol,
                            side: 'BUY',
                            quantity,
                            price: currentPrice
                        })
                    });

                    const trade = await response.json();
                    console.log('Trade executed:', trade);
                    
                    // Add to recent trades
                    this.addRecentTrade({
                        symbol: trade.symbol,
                        side: trade.side,
                        quantity: trade.quantity,
                        price: trade.price,
                        timestamp: trade.timestamp
                    });
                } catch (error) {
                    console.error('Error executing trade:', error);
                }
            }

            addRecentTrade(trade) {
                const recentTrades = document.getElementById('recent-trades');
                const tradeElement = document.createElement('div');
                tradeElement.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-md';
                
                const pnl = Math.random() > 0.5 ? Math.random() * 200 - 100 : 0;
                const pnlColor = pnl >= 0 ? 'text-green-600' : 'text-red-600';
                const pnlSign = pnl >= 0 ? '+' : '';
                
                tradeElement.innerHTML = `
                    <div>
                        <p class="font-medium">${trade.symbol}</p>
                        <p class="text-sm text-gray-500">${trade.side} ${trade.quantity} shares</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold ${pnlColor}">${pnlSign}$${pnl.toFixed(0)}</p>
                        <p class="text-sm text-gray-500">Just now</p>
                    </div>
                `;
                
                recentTrades.insertBefore(tradeElement, recentTrades.firstChild);
                
                // Keep only last 5 trades
                while (recentTrades.children.length > 5) {
                    recentTrades.removeChild(recentTrades.lastChild);
                }
            }

            initializeCharts() {
                // Portfolio Performance Chart
                const portfolioCtx = document.getElementById('portfolio-chart').getContext('2d');
                new Chart(portfolioCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Portfolio Value',
                            data: [95000, 98000, 102000, 105000, 108000, 110000],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });

                // Trade Distribution Chart
                const tradeDistCtx = document.getElementById('trade-distribution-chart').getContext('2d');
                new Chart(tradeDistCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Winning Trades', 'Losing Trades'],
                        datasets: [{
                            data: [68, 32],
                            backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            startPriceUpdates() {
                // Send ping every 30 seconds to keep connection alive
                setInterval(() => {
                    if (this.isConnected) {
                        this.ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000);
            }

            updateConnectionStatus(status, color) {
                const statusElement = document.getElementById('connection-status');
                statusElement.textContent = status;
                statusElement.className = `ml-2 px-2 py-1 bg-${color}-500 rounded-full text-xs`;
            }

            refreshPrice() {
                const symbol = document.getElementById('symbol-select').value;
                if (this.isConnected) {
                    this.ws.send(JSON.stringify({ type: 'subscribe', symbol }));
                }
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new TradingDashboard();
        });
    </script>
</body>
</html>
