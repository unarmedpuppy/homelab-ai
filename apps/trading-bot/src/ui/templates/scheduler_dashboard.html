<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot - Scheduler Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/static/js/dashboard-utils.js"></script>
    <style>
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-running { background-color: #10b981; color: white; }
        .status-stopped { background-color: #ef4444; color: white; }
        .status-paused { background-color: #f59e0b; color: white; }
        .status-error { background-color: #dc2626; color: white; }
        
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .api-log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-left: 3px solid #e5e7eb;
            margin-bottom: 0.5rem;
            background-color: #f9fafb;
        }
        .api-log-entry.success { border-left-color: #10b981; }
        .api-log-entry.error { border-left-color: #ef4444; }
        .api-log-entry.warning { border-left-color: #f59e0b; }
        
        .refresh-indicator {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .error-alert {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
        }
        
        .error-alert.hidden {
            display: none;
        }
        
        .warning-alert {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
        }
        
        .warning-alert.hidden {
            display: none;
        }
        
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.success {
            background-color: #10b981;
            color: white;
        }
        
        .toast.error {
            background-color: #ef4444;
            color: white;
        }
        
        .toast.warning {
            background-color: #f59e0b;
            color: white;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .error-details {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Trading Bot Scheduler</h1>
                    <p class="text-sm text-gray-500 mt-1">Real-time monitoring and API activity</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refresh-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        <span id="refresh-text">Refresh</span>
                        <span id="refresh-spinner" class="hidden inline-block ml-2 refresh-indicator">‚ü≥</span>
                    </button>
                    <a href="/" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
                        <i class="fas fa-chart-line mr-2"></i>Main Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Error Alert (hidden by default) -->
        <div id="error-alert" class="error-alert hidden">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <h3 class="text-lg font-semibold text-red-900">Error</h3>
                    </div>
                    <p id="error-message" class="text-red-800 mt-2"></p>
                    <div id="error-details" class="error-details hidden"></div>
                    <button id="error-details-toggle" class="text-sm text-red-600 underline mt-2" onclick="toggleErrorDetails()">
                        Show Details
                    </button>
                </div>
                <button onclick="hideError()" class="text-red-600 hover:text-red-800 ml-4">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Warning Alert (hidden by default) -->
        <div id="warning-alert" class="warning-alert hidden">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <h3 class="text-lg font-semibold text-yellow-900">Warning</h3>
                    </div>
                    <p id="warning-message" class="text-yellow-800 mt-2"></p>
                </div>
                <button onclick="hideWarning()" class="text-yellow-600 hover:text-yellow-800 ml-4">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Scheduler Status Card -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Scheduler Status</h2>
                <span id="scheduler-state" class="status-badge status-stopped">Loading...</span>
            </div>
            
            <div id="scheduler-status-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="metric-card bg-gray-50 rounded p-4">
                    <div class="text-sm text-gray-500">State</div>
                    <div id="status-state" class="text-2xl font-bold text-gray-900">-</div>
                </div>
                <div class="metric-card bg-gray-50 rounded p-4">
                    <div class="text-sm text-gray-500">Uptime</div>
                    <div id="status-uptime" class="text-2xl font-bold text-gray-900">-</div>
                </div>
                <div class="metric-card bg-gray-50 rounded p-4">
                    <div class="text-sm text-gray-500">Can Run</div>
                    <div id="status-can-run" class="text-2xl font-bold text-gray-900">-</div>
                </div>
                <div class="metric-card bg-gray-50 rounded p-4">
                    <div class="text-sm text-gray-500">IBKR Connected</div>
                    <div id="status-ibkr" class="text-2xl font-bold text-gray-900">-</div>
                </div>
            </div>

            <!-- Scheduler Controls -->
            <div class="mt-6 flex space-x-4">
                <button id="start-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Start
                </button>
                <button id="stop-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Stop
                </button>
                <button id="pause-btn" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Pause
                </button>
                <button id="resume-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Resume
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="text-sm text-gray-500 mb-2">Evaluations Run</div>
                <div id="stat-evaluations" class="text-3xl font-bold text-gray-900">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="text-sm text-gray-500 mb-2">Signals Generated</div>
                <div id="stat-signals" class="text-3xl font-bold text-blue-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="text-sm text-gray-500 mb-2">Trades Executed</div>
                <div id="stat-trades" class="text-3xl font-bold text-green-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="text-sm text-gray-500 mb-2">Trades Rejected</div>
                <div id="stat-rejected" class="text-3xl font-bold text-red-600">-</div>
            </div>
        </div>

        <!-- Additional Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="text-sm text-gray-500 mb-2">Errors</div>
                <div id="stat-errors" class="text-3xl font-bold text-red-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="text-sm text-gray-500 mb-2">Monitored Positions</div>
                <div id="stat-positions" class="text-3xl font-bold text-purple-600">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 metric-card">
                <div class="text-sm text-gray-500 mb-2">Last Evaluation</div>
                <div id="stat-last-eval" class="text-lg font-semibold text-gray-700">-</div>
            </div>
        </div>

        <!-- Configuration -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <div class="text-sm text-gray-500">Evaluation Interval</div>
                    <div id="config-eval-interval" class="text-lg font-semibold">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Exit Check Interval</div>
                    <div id="config-exit-interval" class="text-lg font-semibold">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Min Confidence</div>
                    <div id="config-min-confidence" class="text-lg font-semibold">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Max Concurrent Trades</div>
                    <div id="config-max-trades" class="text-lg font-semibold">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Market Hours Only</div>
                    <div id="config-market-hours" class="text-lg font-semibold">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Market Hours Status</div>
                    <div id="config-market-status" class="text-lg font-semibold">-</div>
                </div>
            </div>
        </div>

        <!-- API Activity Log -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Recent API Activity</h2>
                <button id="clear-log-btn" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                    Clear Log
                </button>
            </div>
            <div id="api-log" class="space-y-2 max-h-96 overflow-y-auto">
                <div class="text-gray-500 text-center py-8">No API activity yet. Activity will appear here as the scheduler runs.</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let refreshInterval = null;
        let apiLog = [];
        let errorDetailsVisible = false;

        // Toast notification system
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Error display functions
        function showError(message, details = null) {
            const alert = document.getElementById('error-alert');
            const messageEl = document.getElementById('error-message');
            const detailsEl = document.getElementById('error-details');
            const toggleBtn = document.getElementById('error-details-toggle');

            messageEl.textContent = message;
            alert.classList.remove('hidden');

            if (details) {
                detailsEl.textContent = typeof details === 'string' ? details : JSON.stringify(details, null, 2);
                toggleBtn.classList.remove('hidden');
            } else {
                detailsEl.classList.add('hidden');
                toggleBtn.classList.add('hidden');
            }

            showToast(message, 'error');
        }

        function hideError() {
            document.getElementById('error-alert').classList.add('hidden');
            errorDetailsVisible = false;
            document.getElementById('error-details').classList.add('hidden');
            document.getElementById('error-details-toggle').textContent = 'Show Details';
        }

        function toggleErrorDetails() {
            errorDetailsVisible = !errorDetailsVisible;
            const detailsEl = document.getElementById('error-details');
            const toggleBtn = document.getElementById('error-details-toggle');

            if (errorDetailsVisible) {
                detailsEl.classList.remove('hidden');
                toggleBtn.textContent = 'Hide Details';
            } else {
                detailsEl.classList.add('hidden');
                toggleBtn.textContent = 'Show Details';
            }
        }

        function showWarning(message) {
            const alert = document.getElementById('warning-alert');
            const messageEl = document.getElementById('warning-message');
            messageEl.textContent = message;
            alert.classList.remove('hidden');
            showToast(message, 'warning');
        }

        function hideWarning() {
            document.getElementById('warning-alert').classList.add('hidden');
        }

        // Make error message more descriptive
        function getErrorMessage(error, responseData = null) {
            if (responseData && responseData.detail) {
                if (typeof responseData.detail === 'string') {
                    return responseData.detail;
                } else if (typeof responseData.detail === 'object') {
                    // Handle structured error details
                    if (responseData.detail.error) {
                        return responseData.detail.error;
                    } else if (responseData.detail.message) {
                        return responseData.detail.message;
                    } else {
                        return JSON.stringify(responseData.detail, null, 2);
                    }
                }
            }
            
            if (error.message) {
                return error.message;
            }
            
            if (error.toString && error.toString() !== '[object Object]') {
                return error.toString();
            }
            
            return 'An unknown error occurred';
        }

        // Format time duration
        function formatUptime(seconds) {
            if (!seconds) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            }
            return `${minutes}m ${secs}s`;
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // Format percentage
        function formatPercent(value) {
            if (value === null || value === undefined) return '-';
            return (value * 100).toFixed(1) + '%';
        }

        // Add API log entry
        function addApiLogEntry(entry) {
            apiLog.unshift(entry);
            if (apiLog.length > 100) {
                apiLog.pop(); // Keep last 100 entries
            }
            renderApiLog();

            // Show errors in alert
            if (entry.status === 'error') {
                const errorMsg = entry.error || entry.summary || 'API request failed';
                showError(errorMsg, entry.errorDetails || null);
            } else if (entry.status === 'warning') {
                showWarning(entry.summary || 'Warning');
            }
        }

        // Render API log
        function renderApiLog() {
            const logContainer = document.getElementById('api-log');
            if (apiLog.length === 0) {
                logContainer.innerHTML = '<div class="text-gray-500 text-center py-8">No API activity yet.</div>';
                return;
            }

            logContainer.innerHTML = apiLog.map(entry => {
                const time = new Date(entry.timestamp).toLocaleTimeString();
                const statusClass = entry.status === 'success' ? 'success' : 
                                  entry.status === 'error' ? 'error' : 'warning';
                
                return `
                    <div class="api-log-entry ${statusClass}">
                        <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold text-gray-900">${entry.method} ${entry.endpoint}</div>
                        <div class="text-gray-600 text-xs mt-1">${entry.summary || ''}</div>
                        ${entry.statusCode ? `<div class="text-gray-500 text-xs mt-1">Status: ${entry.statusCode}${entry.duration ? ` (${entry.duration}ms)` : ''}</div>` : ''}
                        ${entry.error ? `<div class="text-red-600 text-xs mt-1 font-semibold">Error: ${entry.error}</div>` : ''}
                        ${entry.errorDetails ? `<div class="text-red-600 text-xs mt-1 opacity-75">${typeof entry.errorDetails === 'string' ? entry.errorDetails : JSON.stringify(entry.errorDetails).substring(0, 200)}...</div>` : ''}
                    </div>
                            <div class="text-xs text-gray-400 ml-4">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Make API call with logging
        async function apiCall(method, endpoint, body = null) {
            const startTime = Date.now();
            const entry = {
                timestamp: new Date().toISOString(),
                method: method,
                endpoint: endpoint,
                status: 'pending'
            };

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                const duration = Date.now() - startTime;

                entry.status = response.ok ? 'success' : 'error';
                entry.statusCode = response.status;
                entry.duration = duration;
                
                if (response.ok) {
                    // Create summary based on endpoint
                    if (endpoint.includes('/scheduler/status')) {
                        entry.summary = `State: ${data.state}, Evaluations: ${data.stats?.evaluations_run || 0}`;
                    } else if (endpoint.includes('/scheduler/start')) {
                        entry.summary = `Scheduler started: ${data.message}`;
                    } else if (endpoint.includes('/scheduler/stop')) {
                        entry.summary = `Scheduler stopped: ${data.message}`;
                    } else if (endpoint.includes('/scheduler/pause')) {
                        entry.summary = `Scheduler paused: ${data.message}`;
                    } else if (endpoint.includes('/scheduler/resume')) {
                        entry.summary = `Scheduler resumed: ${data.message}`;
                    } else {
                        entry.summary = `Status: ${data.status || 'OK'}`;
                    }
                } else {
                    // Enhanced error handling
                    const errorMessage = getErrorMessage(null, data);
                    entry.error = errorMessage;
                    entry.summary = `Error: ${errorMessage}`;
                    entry.errorDetails = data; // Store full error details
                }

                addApiLogEntry(entry);
                return { ok: response.ok, data };
            } catch (error) {
                entry.status = 'error';
                const errorMessage = getErrorMessage(error);
                entry.error = errorMessage;
                entry.summary = `Network error: ${errorMessage}`;
                entry.errorDetails = {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    type: 'network_error'
                };
                addApiLogEntry(entry);
                
                // Re-throw with enhanced message for caller handling
                const enhancedError = new Error(errorMessage);
                enhancedError.originalError = error;
                enhancedError.apiEntry = entry;
                throw enhancedError;
            }
        }

        // Check for API connection issues
        async function checkApiHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (!response.ok) {
                    showWarning('API health check failed. Some features may not work correctly.');
                }
            } catch (error) {
                showWarning('Cannot connect to API. Please check if the server is running.');
            }
        }

        // Update scheduler status
        async function updateSchedulerStatus() {
            try {
                const { ok, data } = await apiCall('GET', '/api/scheduler/status');
                if (!ok) {
                    const errorMsg = data?.detail || 'Failed to fetch scheduler status';
                    showError(
                        `Unable to get scheduler status: ${errorMsg}`,
                        data
                    );
                    // Update UI to show error state
                    document.getElementById('scheduler-state').className = 'status-badge status-error';
                    document.getElementById('scheduler-state').textContent = 'ERROR';
                    document.getElementById('status-state').textContent = 'ERROR';
                    return;
                }

                // Update state badge
                const stateBadge = document.getElementById('scheduler-state');
                const state = data.state || 'stopped';
                stateBadge.className = `status-badge status-${state}`;
                stateBadge.textContent = state.toUpperCase();

                // Update status fields
                document.getElementById('status-state').textContent = state.toUpperCase();
                document.getElementById('status-uptime').textContent = formatUptime(data.stats?.uptime_seconds);
                document.getElementById('status-can-run').textContent = data.can_run ? 'Yes' : 'No';
                document.getElementById('status-ibkr').textContent = data.ibkr_connected ? 'Connected' : 'Disconnected';

                // Update statistics
                const stats = data.stats || {};
                document.getElementById('stat-evaluations').textContent = stats.evaluations_run || 0;
                document.getElementById('stat-signals').textContent = stats.signals_generated || 0;
                document.getElementById('stat-trades').textContent = stats.trades_executed || 0;
                document.getElementById('stat-rejected').textContent = stats.trades_rejected || 0;
                document.getElementById('stat-errors').textContent = stats.errors || 0;
                document.getElementById('stat-positions').textContent = stats.monitored_positions || 0;
                document.getElementById('stat-last-eval').textContent = formatTimestamp(stats.last_evaluation);

                // Update configuration
                const config = data.config || {};
                document.getElementById('config-eval-interval').textContent = `${config.evaluation_interval || '-'}s`;
                document.getElementById('config-exit-interval').textContent = `${config.exit_check_interval || '-'}s`;
                document.getElementById('config-min-confidence').textContent = formatPercent(config.min_confidence);
                document.getElementById('config-max-trades').textContent = config.max_concurrent_trades || '-';
                document.getElementById('config-market-hours').textContent = config.market_hours_only ? 'Yes' : 'No';
                document.getElementById('config-market-status').textContent = data.is_market_hours ? 'Open' : 'Closed';

                // Update button states
                updateButtonStates(state);

                // Hide any previous errors if status update succeeded
                hideError();

            } catch (error) {
                console.error('Error updating scheduler status:', error);
                const errorMsg = error.message || 'Failed to connect to API';
                showError(
                    `Error updating scheduler status: ${errorMsg}`,
                    error.stack || error.toString()
                );
                
                // Update UI to show error state
                document.getElementById('scheduler-state').className = 'status-badge status-error';
                document.getElementById('scheduler-state').textContent = 'ERROR';
                document.getElementById('status-state').textContent = 'ERROR';
            }
        }

        // Update button states based on scheduler state
        function updateButtonStates(state) {
            document.getElementById('start-btn').disabled = state === 'running';
            document.getElementById('stop-btn').disabled = state === 'stopped';
            document.getElementById('pause-btn').disabled = state !== 'running';
            document.getElementById('resume-btn').disabled = state !== 'paused';
        }

        // Control button handlers with enhanced error handling
        document.getElementById('start-btn').addEventListener('click', async () => {
            try {
                const { ok, data } = await apiCall('POST', '/api/scheduler/start');
                if (ok) {
                    showToast('Scheduler started successfully', 'success');
                    await updateSchedulerStatus();
                } else {
                    const errorMsg = getErrorMessage(null, data);
                    showError(
                        `Failed to start scheduler: ${errorMsg}`,
                        data
                    );
                }
            } catch (error) {
                const errorMsg = getErrorMessage(error);
                showError(
                    `Failed to start scheduler: ${errorMsg}`,
                    error.stack || error.toString()
                );
            }
        });

        document.getElementById('stop-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to stop the scheduler?')) return;
            
            try {
                const { ok, data } = await apiCall('POST', '/api/scheduler/stop');
                if (ok) {
                    showToast('Scheduler stopped successfully', 'success');
                    await updateSchedulerStatus();
                } else {
                    const errorMsg = getErrorMessage(null, data);
                    showError(
                        `Failed to stop scheduler: ${errorMsg}`,
                        data
                    );
                }
            } catch (error) {
                const errorMsg = getErrorMessage(error);
                showError(
                    `Failed to stop scheduler: ${errorMsg}`,
                    error.stack || error.toString()
                );
            }
        });

        document.getElementById('pause-btn').addEventListener('click', async () => {
            try {
                const { ok, data } = await apiCall('POST', '/api/scheduler/pause');
                if (ok) {
                    showToast('Scheduler paused successfully', 'success');
                    await updateSchedulerStatus();
                } else {
                    const errorMsg = getErrorMessage(null, data);
                    showError(
                        `Failed to pause scheduler: ${errorMsg}`,
                        data
                    );
                }
            } catch (error) {
                const errorMsg = getErrorMessage(error);
                showError(
                    `Failed to pause scheduler: ${errorMsg}`,
                    error.stack || error.toString()
                );
            }
        });

        document.getElementById('resume-btn').addEventListener('click', async () => {
            try {
                const { ok, data } = await apiCall('POST', '/api/scheduler/resume');
                if (ok) {
                    showToast('Scheduler resumed successfully', 'success');
                    await updateSchedulerStatus();
                } else {
                    const errorMsg = getErrorMessage(null, data);
                    showError(
                        `Failed to resume scheduler: ${errorMsg}`,
                        data
                    );
                }
            } catch (error) {
                const errorMsg = getErrorMessage(error);
                showError(
                    `Failed to resume scheduler: ${errorMsg}`,
                    error.stack || error.toString()
                );
            }
        });

        document.getElementById('refresh-btn').addEventListener('click', async () => {
            const spinner = document.getElementById('refresh-spinner');
            const text = document.getElementById('refresh-text');
            spinner.classList.remove('hidden');
            text.textContent = 'Refreshing...';
            
            await updateSchedulerStatus();
            
            setTimeout(() => {
                spinner.classList.add('hidden');
                text.textContent = 'Refresh';
            }, 500);
        });

        document.getElementById('clear-log-btn').addEventListener('click', () => {
            if (confirm('Clear API activity log?')) {
                apiLog = [];
                renderApiLog();
            }
        });

        // Auto-refresh every 5 seconds
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(updateSchedulerStatus, 5000);
        }

        // Initialize
        checkApiHealth();
        updateSchedulerStatus();
        startAutoRefresh();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>

