# Prometheus Alert Rules
# ======================
#
# Alert rules for the Trading Bot monitoring system.
# These rules define conditions that trigger alerts when metrics cross thresholds.

groups:
  - name: trading_bot_system
    interval: 30s
    rules:
      # System Health Alerts
      - alert: HighCPUUsage
        expr: system_cpu_usage_percent > 90
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 90% for more than 5 minutes (current: {{ $value }}%)"

      - alert: HighMemoryUsage
        expr: system_memory_usage_percent > 85
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 85% for more than 5 minutes (current: {{ $value }}%)"

      - alert: HighDiskUsage
        expr: system_disk_usage_percent{mountpoint="/"} > 90
        for: 10m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "High disk usage detected"
          description: "Disk usage is above 90% for more than 10 minutes (current: {{ $value }}%)"

      - alert: ServiceDown
        expr: up{job="trading-bot"} == 0
        for: 2m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Trading bot service is down"
          description: "Trading bot service has been down for more than 2 minutes"

  - name: trading_bot_api
    interval: 30s
    rules:
      # API Health Alerts
      - alert: HighErrorRate
        expr: rate(http_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API error rate"
          description: "API error rate is above 0.1 errors/sec for more than 5 minutes (current: {{ $value }} errors/sec)"

      - alert: HighAPIResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API response time"
          description: "95th percentile API response time is above 2 seconds for more than 5 minutes (current: {{ $value }}s)"

      - alert: NoAPIRequests
        expr: rate(http_requests_total[5m]) == 0
        for: 10m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "No API requests received"
          description: "No API requests have been received for more than 10 minutes"

  - name: trading_bot_trading
    interval: 30s
    rules:
      # Trading Alerts
      - alert: HighTradeRejectionRate
        expr: sum(rate(trades_rejected_total[5m])) / (sum(rate(trades_executed_total[5m])) + sum(rate(trades_rejected_total[5m]))) > 0.1
        for: 5m
        labels:
          severity: warning
          component: trading
        annotations:
          summary: "High trade rejection rate"
          description: "Trade rejection rate is above 10% for more than 5 minutes (current: {{ $value | humanizePercentage }})"

      - alert: BrokerDisconnected
        expr: broker_connection_status == 0
        for: 2m
        labels:
          severity: critical
          component: trading
        annotations:
          summary: "Broker connection lost"
          description: "Broker connection has been disconnected for more than 2 minutes"

      - alert: HighSlippage
        expr: histogram_quantile(0.95, rate(slippage_percent_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: trading
        annotations:
          summary: "High slippage detected"
          description: "95th percentile slippage is above 1% for more than 5 minutes (current: {{ $value }}%)"

      - alert: PortfolioDrawdown
        expr: portfolio_total_pnl < -5000
        for: 10m
        labels:
          severity: warning
          component: trading
        annotations:
          summary: "Significant portfolio drawdown"
          description: "Portfolio P/L is below -$5000 for more than 10 minutes (current: ${{ $value }})"

      - alert: DailyLossLimit
        expr: portfolio_daily_pnl < risk_daily_loss_limit
        for: 1m
        labels:
          severity: critical
          component: trading
        annotations:
          summary: "Daily loss limit reached"
          description: "Daily P/L has exceeded the configured loss limit (current: ${{ $value }})"

  - name: trading_bot_providers
    interval: 30s
    rules:
      # Data Provider Alerts
      - alert: HighProviderErrorRate
        expr: rate(provider_errors_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: provider
        annotations:
          summary: "High provider error rate"
          description: "Provider error rate is above 0.05 errors/sec for more than 5 minutes (current: {{ $value }} errors/sec) for provider {{ $labels.provider }}"

      - alert: ProviderRateLimitHits
        expr: rate(provider_rate_limit_hits_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: provider
        annotations:
          summary: "Frequent rate limit hits"
          description: "Provider {{ $labels.provider }} is hitting rate limits frequently ({{ $value }} hits/sec)"

      - alert: LowCacheHitRate
        expr: provider_cache_hit_rate < 0.5
        for: 10m
        labels:
          severity: info
          component: provider
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate for provider {{ $labels.provider }} is below 50% for more than 10 minutes (current: {{ $value | humanizePercentage }})"

      - alert: SlowProviderResponse
        expr: histogram_quantile(0.95, rate(provider_response_time_seconds_bucket[5m])) > 5
        for: 5m
        labels:
          severity: warning
          component: provider
        annotations:
          summary: "Slow provider response time"
          description: "95th percentile response time for provider {{ $labels.provider }} is above 5 seconds (current: {{ $value }}s)"

  - name: trading_bot_strategy
    interval: 30s
    rules:
      # Strategy Alerts
      - alert: SlowStrategyEvaluation
        expr: histogram_quantile(0.95, rate(strategy_evaluation_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: strategy
        annotations:
          summary: "Slow strategy evaluation"
          description: "95th percentile strategy evaluation time is above 1 second for more than 5 minutes (current: {{ $value }}s) for strategy {{ $labels.strategy }}"

      - alert: NoStrategySignals
        expr: rate(signals_generated_total[15m]) == 0
        for: 15m
        labels:
          severity: info
          component: strategy
        annotations:
          summary: "No strategy signals generated"
          description: "No signals have been generated in the last 15 minutes"

      - alert: LowStrategyWinRate
        expr: strategy_win_rate < 0.4
        for: 1h
        labels:
          severity: warning
          component: strategy
        annotations:
          summary: "Low strategy win rate"
          description: "Strategy {{ $labels.strategy }} win rate is below 40% for more than 1 hour (current: {{ $value | humanizePercentage }})"

  - name: trading_bot_risk
    interval: 30s
    rules:
      # Risk Management Alerts
      - alert: MaxDrawdownExceeded
        expr: risk_max_drawdown < -20
        for: 5m
        labels:
          severity: critical
          component: risk
        annotations:
          summary: "Maximum drawdown exceeded"
          description: "Maximum drawdown has exceeded -20% (current: {{ $value }}%)"

      - alert: PositionSizeLimitExceeded
        expr: open_positions * position_pnl / open_positions > risk_position_size_limit
        for: 1m
        labels:
          severity: warning
          component: risk
        annotations:
          summary: "Position size limit exceeded"
          description: "Position size for {{ $labels.symbol }} exceeds configured limit"
