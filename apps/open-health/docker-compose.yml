version: '3.8'

services:
  open-health:
    build:
      context: ./open-health-repo
      dockerfile: Containerfile
    container_name: open-health
    restart: unless-stopped
    ports:
      - "8095:3000"
    environment:
      - NODE_ENV=production
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - DATABASE_URL=${DATABASE_URL:-file:/app/data/db.sqlite}
      - OLLAMA_API_URL=${OLLAMA_API_URL:-http://host.docker.internal:11434}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://192.168.86.47:8095}
      - AUTH_URL=${AUTH_URL:-http://192.168.86.47:8095}
      - AUTH_TRUST_HOST=${AUTH_TRUST_HOST:-true}
    volumes:
      - ./data:/app/data
      - ./uploads:/app/public/uploads
    networks:
      - my-network
    labels:
      - "traefik.enable=true"
      # HTTPS redirect
      - "traefik.http.middlewares.open-health-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.open-health-redirect.middlewares=open-health-redirect"
      - "traefik.http.routers.open-health-redirect.rule=Host(`open-health.server.unarmedpuppy.com`)"
      - "traefik.http.routers.open-health-redirect.entrypoints=web"
      # Main HTTPS router
      - "traefik.http.routers.open-health.rule=Host(`open-health.server.unarmedpuppy.com`)"
      - "traefik.http.routers.open-health.entrypoints=websecure"
      - "traefik.http.routers.open-health.tls.certresolver=myresolver"
      - "traefik.http.routers.open-health.service=open-health"
      - "traefik.http.services.open-health.loadbalancer.server.port=3000"
      # Homepage labels
      - "homepage.group=Health & Wellness"
      - "homepage.name=OpenHealth"
      - "homepage.icon=si-heart"
      - "homepage.href=http://192.168.86.47:8095"
      - "homepage.description=AI Health Assistant powered by your data"

networks:
  my-network:
    external: true

