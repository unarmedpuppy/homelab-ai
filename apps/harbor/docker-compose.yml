version: '3.8'

x-enabled: true

services:
  harbor-db:
    image: goharbor/harbor-db:v2.11.2
    container_name: harbor-db
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${HARBOR_DB_PASSWORD:-root123}
    volumes:
      - ./data/database:/var/lib/postgresql/data:z
    networks:
      - harbor-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  harbor-redis:
    image: goharbor/redis-photon:v2.11.2
    container_name: harbor-redis
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - ./data/redis:/var/lib/redis
    networks:
      - harbor-internal

  harbor-registry:
    image: goharbor/registry-photon:v2.11.2
    container_name: harbor-registry
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - ./data/registry:/storage:z
      - type: bind
        source: ./config/registry/config.yml
        target: /etc/registry/config.yml
      - type: bind
        source: ./config/registry/root.crt
        target: /etc/registry/root.crt
      - type: bind
        source: ./config/shared/trust-certificates
        target: /harbor_cust_cert
    networks:
      - harbor-internal

  harbor-registryctl:
    image: goharbor/harbor-registryctl:v2.11.2
    container_name: harbor-registryctl
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    environment:
      CORE_SECRET: ${HARBOR_CORE_SECRET:-changeit}
    volumes:
      - ./data/registry:/storage:z
      - type: bind
        source: ./config/registry/config.yml
        target: /etc/registry/config.yml
      - type: bind
        source: ./config/registryctl/config.yml
        target: /etc/registryctl/config.yml
      - type: bind
        source: ./config/shared/trust-certificates
        target: /harbor_cust_cert
    networks:
      - harbor-internal

  harbor-core:
    image: goharbor/harbor-core:v2.11.2
    container_name: harbor-core
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    environment:
      CORE_KEY: ${HARBOR_CORE_KEY:-change-me-please}
      CORE_SECRET: ${HARBOR_CORE_SECRET:-changeit}
      JOBSERVICE_SECRET: ${HARBOR_JOBSERVICE_SECRET:-changeit}
      _REDIS_URL_CORE: redis://harbor-redis:6379/0
      SYNC_QUOTA: "true"
      CHART_CACHE_DRIVER: redis
      _REDIS_URL_REG: redis://harbor-redis:6379/1
      PORTAL_URL: http://harbor-portal:8080
      REGISTRY_URL: http://harbor-registry:5000
      TOKEN_SERVICE_URL: http://harbor-core:8080/service/token
      CORE_URL: http://harbor-core:8080
      CORE_LOCAL_URL: http://127.0.0.1:8080
      JOBSERVICE_URL: http://harbor-jobservice:8080
      TRIVY_ADAPTER_URL: http://harbor-trivy:8080
      REGISTRY_STORAGE_PROVIDER_NAME: filesystem
      LOG_LEVEL: info
      CONFIG_PATH: /etc/core/app.conf
      PERMITTED_REGISTRY_TYPES_FOR_PROXY_CACHE: docker-hub,harbor,azure-acr,aws-ecr,google-gcr,quay,docker-registry,github-ghcr,jfrog-artifactory
      DATABASE_TYPE: postgresql
      POSTGRESQL_HOST: harbor-db
      POSTGRESQL_PORT: 5432
      POSTGRESQL_USERNAME: postgres
      POSTGRESQL_PASSWORD: ${HARBOR_DB_PASSWORD:-root123}
      POSTGRESQL_DATABASE: registry
      POSTGRESQL_SSLMODE: disable
      EXT_ENDPOINT: https://harbor.server.unarmedpuppy.com
      REGISTRY_CREDENTIAL_USERNAME: harbor_registry_user
      REGISTRY_CREDENTIAL_PASSWORD: ${HARBOR_CORE_SECRET:-changeit}
    volumes:
      - ./data/ca_download/:/etc/core/ca/:z
      - ./data/core/:/data/:z
      - type: bind
        source: ./config/core/app.conf
        target: /etc/core/app.conf
      - type: bind
        source: ./config/core/private_key.pem
        target: /etc/core/private_key.pem
      - type: bind
        source: ./config/shared/trust-certificates
        target: /harbor_cust_cert
    networks:
      - harbor-internal
    depends_on:
      harbor-db:
        condition: service_healthy
      harbor-registry:
        condition: service_started
      harbor-redis:
        condition: service_started

  harbor-portal:
    image: goharbor/harbor-portal:v2.11.2
    container_name: harbor-portal
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
    networks:
      - harbor-internal

  harbor-jobservice:
    image: goharbor/harbor-jobservice:v2.11.2
    container_name: harbor-jobservice
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    environment:
      CORE_SECRET: ${HARBOR_CORE_SECRET:-changeit}
      JOBSERVICE_SECRET: ${HARBOR_JOBSERVICE_SECRET:-changeit}
      CORE_URL: http://harbor-core:8080
      REGISTRY_URL: http://harbor-registry:5000
      REGISTRY_CONTROLLER_URL: http://harbor-registryctl:8080
    volumes:
      - ./data/job_logs:/var/log/jobs:z
      - type: bind
        source: ./config/jobservice/config.yml
        target: /etc/jobservice/config.yml
    networks:
      - harbor-internal
    depends_on:
      - harbor-core

  harbor-trivy:
    image: goharbor/trivy-adapter-photon:v2.11.2
    container_name: harbor-trivy
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    environment:
      SCANNER_LOG_LEVEL: info
      SCANNER_TRIVY_CACHE_DIR: /home/scanner/.cache/trivy
      SCANNER_TRIVY_REPORTS_DIR: /home/scanner/.cache/reports
      SCANNER_TRIVY_DEBUG_MODE: "false"
      SCANNER_TRIVY_VULN_TYPE: os,library
      SCANNER_TRIVY_SECURITY_CHECKS: vuln
      SCANNER_TRIVY_GITHUB_TOKEN: ""
      SCANNER_TRIVY_SEVERITY: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
      SCANNER_TRIVY_IGNORE_UNFIXED: "false"
      SCANNER_TRIVY_SKIP_UPDATE: "false"
      SCANNER_TRIVY_INSECURE: "false"
      SCANNER_REDIS_URL: redis://harbor-redis:6379/5
      SCANNER_STORE_REDIS_URL: redis://harbor-redis:6379/5
      SCANNER_JOB_QUEUE_REDIS_URL: redis://harbor-redis:6379/5
    volumes:
      - ./data/trivy-adapter/trivy:/home/scanner/.cache/trivy:z
      - ./data/trivy-adapter/reports:/home/scanner/.cache/reports:z
    networks:
      - harbor-internal
    depends_on:
      - harbor-redis

  harbor-proxy:
    image: goharbor/nginx-photon:v2.11.2
    container_name: harbor-proxy
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
    volumes:
      - type: bind
        source: ./config/proxy/nginx.conf
        target: /etc/nginx/nginx.conf
    networks:
      - harbor-internal
      - my-network
    depends_on:
      - harbor-registry
      - harbor-core
      - harbor-portal
    labels:
      # Traefik configuration
      - "traefik.enable=true"
      - "traefik.docker.network=my-network"
      # HTTP to HTTPS redirect
      - "traefik.http.middlewares.harbor-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.harbor-redirect.middlewares=harbor-redirect"
      - "traefik.http.routers.harbor-redirect.rule=Host(`harbor.server.unarmedpuppy.com`)"
      - "traefik.http.routers.harbor-redirect.entrypoints=web"
      # HTTPS router (no basic auth - Harbor has its own auth)
      - "traefik.http.routers.harbor.rule=Host(`harbor.server.unarmedpuppy.com`)"
      - "traefik.http.routers.harbor.entrypoints=websecure"
      - "traefik.http.routers.harbor.tls.certresolver=myresolver"
      - "traefik.http.routers.harbor.tls=true"
      - "traefik.http.services.harbor.loadbalancer.server.port=8080"
      # Homepage labels
      - "homepage.group=Infrastructure"
      - "homepage.name=Harbor Registry"
      - "homepage.icon=si-harbor"
      - "homepage.href=https://harbor.server.unarmedpuppy.com"
      - "homepage.description=Enterprise container registry with proxy cache"

networks:
  harbor-internal:
    driver: bridge
  my-network:
    external: true
