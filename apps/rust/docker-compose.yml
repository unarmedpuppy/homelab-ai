version: '3.7'

# Auto-start configuration: disabled - Rust server should be started manually
x-enabled: false

services:
  rust-server:
    image: didstopia/rust-server
    environment:
      - RUST_SERVER_STARTUP_ARGUMENTS=-batchmode -load -nographics +server.secure 1 +server.saveinterval 60 +decay.delay_override 2880 +decay.duration_override 2880
      - RUST_SERVER_IDENTITY=unarmedpuppy
      #- RUST_SERVER_SEED=174932776 #SMALL
      #- RUST_SERVER_WORLDSIZE=1000
      - RUST_SERVER_SEED=1473311375
      - RUST_SERVER_WORLDSIZE=2000
      - RUST_SERVER_MAXPLAYERS=64
      - RUST_SERVER_NAME=[US] Sulfur Boyz - Practice Girl Map v2.0
      - RUST_SERVER_DESCRIPTION=It's been 84 years. Long live Sulfur Boyz.
      - RUST_SERVER_URL=https://discord.gg/wtCph8rQ
      - RUST_SERVER_BANNER_URL=https://i.imgur.com/FIXxuRI.jpg
      - RUST_SERVER_PORT=28015
      - RUST_SERVER_QUERY_PORT=28017
      - RUST_RCON_WEB=1
      - RUST_RCON_PORT=28016
      - RUST_RCON_PASSWORD=hotdrops
      - RUST_UPDATE_CHECKING=1
      - RUST_UPDATE_BRANCH=public
      - RUST_START_MODE=2 # 2 = Automatically start the server when the container is started
      - RUST_OXIDE_ENABLED=0
      - RUST_APP_PORT=28082
      - PUID=1000
      - PGID=1000
    ports:
      - "8080:8080" # web rcon port
      - "28015:28015/tcp" # ?
      - "28015:28015/udp" # game port
      - "28016:28016/tcp" # rcon port
      - "28016:28016/udp" # rcon port
      - "28017:28017/udp" # query port for server
      - "28082:28082" # app port rust+
    volumes:
      - ./data/rust:/steamcmd/rust
    restart: "no"  # Disabled - must be started manually
    labels:
      - "traefik.enable=true"
      # Rust Server - HTTPS redirect
      - "traefik.http.middlewares.rust-server-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.rust-server-redirect.middlewares=rust-server-redirect"
      - "traefik.http.routers.rust-server-redirect.rule=Host(`rust.server.unarmedpuppy.com`)"
      - "traefik.http.routers.rust-server-redirect.entrypoints=web"
      # Rust Server - Local network access (no auth)
      - "traefik.http.routers.rust-server-local.rule=Host(`rust.server.unarmedpuppy.com`) && ClientIP(`192.168.86.0/24`)"
      - "traefik.http.routers.rust-server-local.priority=100"
      - "traefik.http.routers.rust-server-local.entrypoints=websecure"
      - "traefik.http.routers.rust-server-local.tls.certresolver=myresolver"
      - "traefik.http.routers.rust-server-local.service=rust-server"
      # Rust Server - External access (requires auth)
      - "traefik.http.routers.rust-server.rule=Host(`rust.server.unarmedpuppy.com`)"
      - "traefik.http.routers.rust-server.priority=1"
      - "traefik.http.routers.rust-server.entrypoints=websecure"
      - "traefik.http.routers.rust-server.tls.certresolver=myresolver"
      - "traefik.http.routers.rust-server.middlewares=rust-server-auth"
      - "traefik.http.routers.rust-server.service=rust-server"
      - "traefik.http.services.rust-server.loadbalancer.server.port=28015"
      - "traefik.http.middlewares.rust-server-auth.basicauth.users=unarmedpuppy:$$apr1$$yE.A6vVX$$p7.fpGKw5Unp0UW6H/2c.0"
      - "traefik.http.middlewares.rust-server-auth.basicauth.realm=Rust Server"
      # RCON - HTTPS redirect
      - "traefik.http.middlewares.rust-rcon-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.rust-rcon-redirect.middlewares=rust-rcon-redirect"
      - "traefik.http.routers.rust-rcon-redirect.rule=Host(`rcon-rust.server.unarmedpuppy.com`)"
      - "traefik.http.routers.rust-rcon-redirect.entrypoints=web"
      # RCON - Local network access (no auth)
      - "traefik.http.routers.rust-rcon-local.rule=Host(`rcon-rust.server.unarmedpuppy.com`) && ClientIP(`192.168.86.0/24`)"
      - "traefik.http.routers.rust-rcon-local.priority=100"
      - "traefik.http.routers.rust-rcon-local.entrypoints=websecure"
      - "traefik.http.routers.rust-rcon-local.tls.certresolver=myresolver"
      - "traefik.http.routers.rust-rcon-local.service=rust-rcon"
      # RCON - External access (requires auth)
      - "traefik.http.routers.rust-rcon.rule=Host(`rcon-rust.server.unarmedpuppy.com`)"
      - "traefik.http.routers.rust-rcon.priority=1"
      - "traefik.http.routers.rust-rcon.entrypoints=websecure"
      - "traefik.http.routers.rust-rcon.tls.certresolver=myresolver"
      - "traefik.http.routers.rust-rcon.middlewares=rust-rcon-auth"
      - "traefik.http.routers.rust-rcon.service=rust-rcon"
      - "traefik.http.services.rust-rcon.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.rust-rcon-auth.basicauth.users=unarmedpuppy:$$apr1$$yE.A6vVX$$p7.fpGKw5Unp0UW6H/2c.0"
      - "traefik.http.middlewares.rust-rcon-auth.basicauth.realm=Rust RCON"
      # RCON WebSocket - Local network access (no auth)
      - "traefik.http.routers.rust-rcon-ws-local.rule=Host(`rcon-rust.server.unarmedpuppy.com`) && ClientIP(`192.168.86.0/24`)"
      - "traefik.http.routers.rust-rcon-ws-local.priority=100"
      - "traefik.http.routers.rust-rcon-ws-local.entrypoints=websecure"
      - "traefik.http.routers.rust-rcon-ws-local.tls.certresolver=myresolver"
      - "traefik.http.routers.rust-rcon-ws-local.service=rust-rcon-ws"
      # RCON WebSocket - External access (requires auth)
      - "traefik.http.routers.rust-rcon-ws.rule=Host(`rcon-rust.server.unarmedpuppy.com`)"
      - "traefik.http.routers.rust-rcon-ws.priority=1"
      - "traefik.http.routers.rust-rcon-ws.entrypoints=websecure"
      - "traefik.http.routers.rust-rcon-ws.tls.certresolver=myresolver"
      - "traefik.http.routers.rust-rcon-ws.middlewares=rust-rcon-ws-auth"
      - "traefik.http.routers.rust-rcon-ws.service=rust-rcon-ws"
      - "traefik.http.services.rust-rcon-ws.loadbalancer.server.port=28016"
      - "traefik.http.middlewares.rust-rcon-ws-auth.basicauth.users=unarmedpuppy:$$apr1$$yE.A6vVX$$p7.fpGKw5Unp0UW6H/2c.0"
      - "traefik.http.middlewares.rust-rcon-ws-auth.basicauth.realm=Rust RCON WebSocket"
      # Homepage labels
      - "homepage.group=Gaming"
      - "homepage.name=Rust Server"
      - "homepage.icon=si-rust"
      - "homepage.href=https://rust.server.unarmedpuppy.com"
      - "homepage.description=Rust server, UDP traffic on port 28015"
    networks:
      - my-network

networks:
  my-network:
    external: true
