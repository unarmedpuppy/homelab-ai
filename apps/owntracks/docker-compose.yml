version: '3'

services:
  owntracks:
    # image: owntracks/recorder:latest
    image: harbor.server.unarmedpuppy.com/docker-hub/owntracks/recorder:latest
    container_name: owntracks
    restart: unless-stopped
    volumes:
      - ./data/store:/store
      - ./data/config:/config
    environment:
      - OTR_HOST=mosquitto
      - OTR_PORT=1883
      - OTR_USER=owntracks
      - OTR_PASS=${OTR_PASS:-changeme}
      - OTR_HTTPHOST=0.0.0.0
      - OTR_HTTPPORT=8083
    networks:
      - my-network
    depends_on:
      - mosquitto
    labels:
      - "traefik.enable=true"
      # HTTPS redirect
      - "traefik.http.middlewares.owntracks-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.owntracks-redirect.middlewares=owntracks-redirect"
      - "traefik.http.routers.owntracks-redirect.rule=Host(`owntracks.server.unarmedpuppy.com`)"
      - "traefik.http.routers.owntracks-redirect.entrypoints=web"
      # Local network access (no auth) - highest priority
      - "traefik.http.routers.owntracks-local.rule=Host(`owntracks.server.unarmedpuppy.com`) && ClientIP(`192.168.86.0/24`)"
      - "traefik.http.routers.owntracks-local.priority=100"
      - "traefik.http.routers.owntracks-local.entrypoints=websecure"
      - "traefik.http.routers.owntracks-local.tls.certresolver=myresolver"
      # External access (requires auth) - lowest priority
      - "traefik.http.routers.owntracks.rule=Host(`owntracks.server.unarmedpuppy.com`)"
      - "traefik.http.routers.owntracks.priority=1"
      - "traefik.http.routers.owntracks.entrypoints=websecure"
      - "traefik.http.routers.owntracks.tls.certresolver=myresolver"
      - "traefik.http.routers.owntracks.tls=true"
      - "traefik.http.routers.owntracks.middlewares=owntracks-auth"
      # Service and auth middleware
      - "traefik.http.services.owntracks.loadbalancer.server.port=8083"
      - "traefik.http.middlewares.owntracks-auth.basicauth.users=unarmedpuppy:$$apr1$$yE.A6vVX$$p7.fpGKw5Unp0UW6H/2c.0"
      - "traefik.http.middlewares.owntracks-auth.basicauth.realm=OwnTracks"
      # Homepage labels
      - "homepage.group=Infrastructure"
      - "homepage.name=OwnTracks"
      - "homepage.icon=si-googlemaps"
      - "homepage.href=https://owntracks.server.unarmedpuppy.com"
      - "homepage.description=Location tracking and recording"

  mosquitto:
    # image: eclipse-mosquitto:latest
    image: harbor.server.unarmedpuppy.com/docker-hub/library/eclipse-mosquitto:latest
    container_name: owntracks-mosquitto
    restart: unless-stopped
    volumes:
      - ./data/mosquitto/config:/mosquitto/config
      - ./data/mosquitto/data:/mosquitto/data
      - ./data/mosquitto/log:/mosquitto/log
    networks:
      - my-network
    ports:
      - "1883:1883"   # MQTT
      - "8883:8883"   # MQTT over TLS
    environment:
      - TZ=America/Chicago

networks:
  my-network:
    external: true

