<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Telegram Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    header { display:flex; gap:12px; align-items: center; margin-bottom: 16px; }
    input, select { padding: 6px 8px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    .msg { white-space: pre-wrap; }
    .thumb { max-width: 160px; max-height: 160px; border: 1px solid #ddd; border-radius: 8px; }
    .meta { color:#666; font-size: 12px; }
    .pager { margin-top: 14px; display: flex; gap: 8px; align-items: center; }
    .pager a { text-decoration: none; padding: 6px 10px; border:1px solid #ddd; border-radius: 6px; }
    .pager strong { padding: 0 6px; }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
      <h1>üì® Telegram Messages</h1>
      <a href="/channels" style="background: #6c757d; color: white; text-decoration: none; padding: 8px 16px; border-radius: 4px; font-size: 14px;">View Channels</a>
    </div>
    
    <form method="get" action="/messages">
      <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
        <select name="channel_id" style="min-width: 200px;">
          <option value="">All Channels</option>
          {% for channel in channels %}
            <option value="{{ channel.id }}" {{ "selected" if selected_channel_id == channel.id else "" }}>
              {{ channel.title }}{% if channel.username %} (@{{ channel.username }}){% endif %}
            </option>
          {% endfor %}
        </select>
        
        <input type="text" name="q" placeholder="Search text‚Ä¶" value="{{ q }}" style="min-width: 200px;"/>
        
        <label style="display: flex; align-items: center; gap: 4px;">
          <input type="checkbox" name="has_media" value="1" {{ "checked" if has_media == 1 else "" }}/>
          With media
        </label>
        
        <select name="per_page">
          {% for n in [25,50,100,200] %}
            <option value="{{n}}" {{ "selected" if per_page==n else "" }}>{{n}} / page</option>
          {% endfor %}
        </select>
        
        <select name="sort">
          <option value="desc" {{ "selected" if sort=="desc" else "" }}>Newest first</option>
          <option value="asc"  {{ "selected" if sort=="asc"  else "" }}>Oldest first</option>
        </select>
        
        <button type="submit">Apply</button>
      </div>
    </form>
  </header>

  <table>
    <thead>
      <tr>
        <th style="width:120px;">ID</th>
        <th style="width:200px;">Channel</th>
        <th style="width:200px;">When / Who</th>
        <th>Message</th>
        <th style="width:180px;">Media</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr>
        <td><div class="meta">#{{ it.id }}</div></td>
        <td>
          <div class="meta" style="font-weight: 600;">{{ it.channel_title or "Unknown Channel" }}</div>
          {% if it.channel_username %}
            <div class="meta">@{{ it.channel_username }}</div>
          {% endif %}
        </td>
        <td>
          <div class="meta">{{ it.date or "" }}</div>
          <div class="meta">sender: {{ it.sender_id or "n/a" }}</div>
        </td>
        <td class="msg">{{ it.text }}</td>
        <td>
          {% if it.media_url %}
            <a href="{{ it.media_url }}" target="_blank">
              <img class="thumb" src="{{ it.media_url }}" alt="media"/>
            </a>
          {% else %}
            <span class="meta">‚Äî</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="pager">
    {% set prev = page-1 %}
    {% set next = page+1 %}
    {% if page > 1 %}
      <a href="?channel_id={{selected_channel_id}}&q={{q}}&has_media={{has_media}}&per_page={{per_page}}&sort={{sort}}&page={{prev}}">‚Üê Prev</a>
    {% endif %}
    <strong>Page {{page}} / {{total_pages}}</strong>
    {% if page < total_pages %}
      <a href="?channel_id={{selected_channel_id}}&q={{q}}&has_media={{has_media}}&per_page={{per_page}}&sort={{sort}}&page={{next}}">Next ‚Üí</a>
    {% endif %}
    <span class="meta">Total: {{ total }}</span>
  </div>
</body>
</html>
