# Agent System Data Model

**Unified data model documentation for all agent system data storage.**

## Overview

The agent system uses **Markdown as the primary storage format** for human readability, with supporting structures for fast querying. This document describes the data model for all agent system components.

## Design Principles

1. **Human Readable First**: All data stored in Markdown format
2. **Version Controlled**: All data files are in Git
3. **Queryable**: MCP tools and helper scripts provide query capabilities
4. **Consistent**: Standardized formats across all components
5. **Observable**: All operations go through MCP tools (logged automatically)

---

## 1. Agent Status & Registry

### Storage Locations

- **Primary Source**: `agents/apps/agent-monitoring/data/agent_activity.db` (SQLite)
  - Table: `agent_status`
  - Fields: `agent_id`, `status`, `current_task_id`, `progress`, `blockers`, `last_updated`
  
- **Human-Readable View**: `agents/registry/agent-registry.md` (Markdown)
  - Auto-generated from monitoring DB
  - Read-only (do not edit manually)
  - Generated by: `agents/registry/sync_registry.py`

- **Agent Definitions**: `agents/registry/agent-definitions/*.md` (Markdown with YAML frontmatter)
  - Source of truth for agent metadata
  - Contains: `agent_id`, `specialization`, `status`, `created_by`, `created_date`, etc.

### Data Model

**Agent Status (Monitoring DB)**:
```sql
CREATE TABLE agent_status (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id TEXT NOT NULL UNIQUE,
    status TEXT NOT NULL,  -- active, idle, blocked, completed
    current_task_id TEXT,
    progress TEXT,
    blockers TEXT,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**Agent Registry (Markdown)**:
```markdown
| Agent ID | Specialization | Created By | Created Date | Status | Location |
|----------|---------------|------------|--------------|--------|----------|
| agent-001 | server-management | agent-001 | 2025-01-10 | active | `agents/active/agent-001-server-management/` |
```

**Agent Definition (Markdown + YAML)**:
```yaml
---
agent_id: agent-001
specialization: server-management
created_by: agent-001
created_date: 2025-01-10
status: active
parent_agent: agent-001
template: server-management-agent
---
# Agent Definition Content...
```

### Query Methods

- **MCP Tools**: `get_agent_status()`, `query_agent_registry()`
- **Direct**: Read `agent-registry.md` (read-only)
- **Sync**: Run `sync_agent_registry()` to regenerate from DB

---

## 2. Task Registry

### Storage Location

- **Primary Source**: `agents/tasks/registry.md` (Markdown table)
  - Source of truth for all tasks
  - Human-readable table format

### Data Model

**Task Registry (Markdown Table)**:
```markdown
| Task ID | Title | Description | Status | Assignee | Priority | Dependencies | Project | Created | Updated |
|---------|-------|-------------|--------|----------|----------|--------------|---------|---------|---------|
| T1.1 | Setup database | Create PostgreSQL schema | in_progress | agent-001 | high | - | home-server | 2025-01-13 10:00:00 | 2025-01-13 11:30:00 |
```

**Task Fields**:
- `task_id`: Unique identifier (format: `T{project_number}.{task_number}`)
- `title`: Brief task title
- `description`: Detailed description
- `status`: `pending`, `claimed`, `in_progress`, `blocked`, `review`, `completed`, `cancelled`
- `assignee`: Agent ID assigned to task (or `-` if unassigned)
- `priority`: `low`, `medium`, `high`
- `dependencies`: Comma-separated task IDs (or `-` if none)
- `project`: Project name
- `created`: ISO timestamp
- `updated`: ISO timestamp

### Query Methods

- **MCP Tools**: `query_tasks()`, `get_task()`, `claim_task()`, `update_task_status()`
- **Direct**: Read `agents/tasks/registry.md` (use MCP tools for modifications)

---

## 3. Agent Messages

### Storage Locations

- **Message Files**: `agents/communication/messages/MSG-*.md` (Markdown with YAML frontmatter)
  - One file per message
  - Human-readable format
  
- **Message Index**: `agents/communication/messages/index.json` (JSON)
  - Quick lookup index
  - Updated automatically when messages are created/updated

### Data Model

**Message File (Markdown + YAML)**:
```yaml
---
message_id: MSG-2025-01-13-001
from_agent: agent-001
to_agent: agent-002
type: request
priority: high
status: pending
subject: Need help with deployment
created_at: 2025-01-13T10:30:00Z
acknowledged_at: null
resolved_at: null
related_task_id: T1.5
related_message_id: null
---

# Message Content

Full message body in markdown format.
```

**Message Index (JSON)**:
```json
{
  "messages": [
    {
      "message_id": "MSG-2025-01-13-001",
      "from_agent": "agent-001",
      "to_agent": "agent-002",
      "type": "request",
      "priority": "high",
      "status": "pending",
      "created_at": "2025-01-13T10:30:00Z",
      "file": "messages/MSG-2025-01-13-001.md"
    }
  ]
}
```

**Message Fields**:
- `message_id`: Unique identifier (format: `MSG-YYYY-MM-DD-###`)
- `from_agent`: Agent ID sending message
- `to_agent`: Agent ID receiving (or `"all"` for broadcast)
- `type`: `request`, `response`, `notification`, `escalation`
- `priority`: `low`, `medium`, `high`, `urgent`
- `status`: `pending`, `acknowledged`, `in_progress`, `resolved`, `escalated`
- `subject`: Brief subject line
- `created_at`: ISO 8601 timestamp
- `acknowledged_at`: ISO 8601 timestamp (or null)
- `resolved_at`: ISO 8601 timestamp (or null)
- `related_task_id`: Related task ID (optional)
- `related_message_id`: Original message ID for responses (optional)

### Query Methods

- **MCP Tools**: `get_agent_messages()`, `query_messages()`, `send_agent_message()`
- **Direct**: Read message files or index.json (use MCP tools for modifications)

---

## 4. Memory System

### Storage Locations

- **Primary Source**: `agents/memory/memory.db` (SQLite)
  - Tables: `decisions`, `patterns`, `context`
  - Fast queries and full-text search
  
- **Human-Readable Exports**: `agents/memory/memory/export/` (Markdown)
  - Optional exports for human review
  - Organized by type and date

### Data Model

**Decisions (SQLite)**:
```sql
CREATE TABLE decisions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content TEXT NOT NULL,
    rationale TEXT,
    project TEXT,
    task TEXT,
    importance REAL,
    tags TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**Patterns (SQLite)**:
```sql
CREATE TABLE patterns (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    solution TEXT,
    severity TEXT,
    frequency INTEGER DEFAULT 1,
    tags TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**Context (SQLite)**:
```sql
CREATE TABLE context (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id TEXT,
    task TEXT,
    current_work TEXT,
    status TEXT,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**Markdown Export Format**:
```markdown
# Decision: Use PostgreSQL for database

**Date**: 2025-01-13 10:30:00
**Project**: home-server
**Task**: T1.3
**Importance**: 0.9

## Decision

Use PostgreSQL for database

## Rationale

Need ACID compliance and concurrent writes.

## Tags

- database
- architecture
```

### Query Methods

- **MCP Tools**: `memory_query_decisions()`, `memory_query_patterns()`, `memory_search()`
- **Direct**: SQLite queries (use MCP tools for consistency)
- **Export**: `memory_export_to_markdown()` for human review

---

## 5. Agent Activity & Monitoring

### Storage Location

- **Primary Source**: `agents/apps/agent-monitoring/data/agent_activity.db` (SQLite)
  - Tables: `agent_status`, `agent_actions`, `agent_sessions`
  - Time-series data for monitoring

### Data Model

**Agent Actions (SQLite)**:
```sql
CREATE TABLE agent_actions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id TEXT NOT NULL,
    action_type TEXT NOT NULL,
    tool_name TEXT,
    parameters TEXT,
    result_status TEXT NOT NULL,
    duration_ms INTEGER,
    error TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**Agent Sessions (SQLite)**:
```sql
CREATE TABLE agent_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    agent_id TEXT NOT NULL,
    session_start TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    session_end TIMESTAMP,
    tasks_completed INTEGER DEFAULT 0,
    tools_called INTEGER DEFAULT 0
)
```

### Query Methods

- **MCP Tools**: `get_agent_status()`, `start_agent_session()`, `end_agent_session()`
- **Dashboard**: `agents/apps/agent-monitoring/` (Next.js frontend)
- **Grafana**: Time-series visualizations

---

## Data Relationships

### Agent → Tasks
- Agents can be assigned to tasks (`assignee` field in task registry)
- Tasks tracked in `agents/tasks/registry.md`

### Agent → Messages
- Agents send/receive messages via communication protocol
- Messages stored in `agents/communication/messages/`

### Agent → Memory
- Agents record decisions, patterns, and context
- Stored in `agents/memory/memory.db`

### Agent → Status
- Agent status tracked in monitoring DB
- Registry markdown auto-generated from DB

### Tasks → Dependencies
- Tasks can depend on other tasks
- Dependencies tracked in task registry (`dependencies` field)

### Messages → Tasks
- Messages can link to tasks (`related_task_id` field)
- Enables task-related communication

---

## Query Patterns

### Common Queries

**Find all tasks for an agent**:
```python
query_tasks(assignee="agent-001", status="in_progress")
```

**Find pending messages for an agent**:
```python
get_agent_messages(agent_id="agent-001", status="pending")
```

**Find related decisions**:
```python
memory_query_decisions(project="home-server", search_text="database")
```

**Get agent status**:
```python
get_agent_status(agent_id="agent-001")
```

### Helper Scripts

For direct markdown querying (when MCP tools unavailable):

- **Task Registry**: Read `agents/tasks/registry.md` directly
- **Message Index**: Read `agents/communication/messages/index.json`
- **Agent Registry**: Read `agents/registry/agent-registry.md` (read-only)
- **Memory**: Use SQLite queries or export to markdown

---

## Data Consistency

### Sync Mechanisms

1. **Agent Registry**: Auto-synced from monitoring DB via `sync_registry.py`
   - Run automatically after agent creation/archiving/reactivation
   - Can be run manually: `sync_agent_registry()` MCP tool

2. **Task Registry**: Single source of truth (markdown)
   - All updates via MCP tools
   - No sync needed (direct markdown updates)

3. **Messages**: Single source of truth (markdown files + index.json)
   - All updates via MCP tools
   - Index.json updated automatically

4. **Memory**: SQLite primary, markdown exports optional
   - All updates via MCP tools
   - Exports generated on demand

### Best Practices

1. **Always use MCP tools** for data modifications
2. **Don't edit markdown files directly** (except for agent-specific notes)
3. **Use sync tools** when needed (agent registry)
4. **Check consistency** if manual edits were made
5. **Version control** all data files (Git)

---

## File Organization

```
agents/
├── registry/
│   ├── agent-registry.md          # Auto-generated from DB (read-only)
│   ├── agent-definitions/          # Agent definitions (source of truth)
│   └── sync_registry.py            # Sync script
├── tasks/
│   ├── registry.md                 # Task registry (source of truth)
│   └── README.md                   # Task coordination guide
├── communication/
│   ├── messages/                   # Message files
│   │   ├── index.json              # Message index
│   │   └── MSG-*.md                # Individual messages
│   ├── protocol.md                 # Protocol specification
│   └── README.md                   # Communication guide
├── memory/
│   ├── memory.db                   # SQLite database (primary)
│   ├── memory/export/              # Markdown exports (optional)
│   └── sqlite_memory.py            # Memory API
└── active/
    └── {agent-id}/                 # Per-agent directories
        ├── TASKS.md                # Agent-specific notes (optional)
        └── STATUS.md               # Agent-specific status (optional)

agents/apps/agent-monitoring/
└── data/
    └── agent_activity.db           # Monitoring database
```

---

## Summary

### Storage Strategy

| Component | Primary Storage | Human-Readable | Query Method |
|-----------|---------------|----------------|--------------|
| Agent Status | SQLite DB | Auto-generated markdown | MCP tools |
| Agent Registry | Auto-generated markdown | Markdown | MCP tools |
| Tasks | Markdown | Markdown | MCP tools |
| Messages | Markdown files | Markdown | MCP tools |
| Memory | SQLite DB | Optional markdown exports | MCP tools |
| Activity | SQLite DB | Dashboard/Grafana | MCP tools |

### Key Principles

1. **Markdown First**: Human-readable format preferred
2. **MCP Tools**: All modifications via MCP tools (observable)
3. **Version Control**: All data files in Git
4. **Consistency**: Single source of truth for each component
5. **Queryability**: MCP tools provide query capabilities

---

**Last Updated**: 2025-01-13  
**Status**: Active  
**See Also**:
- `agents/docs/SYSTEM_ARCHITECTURE.md` - System architecture
- `agents/docs/COMMUNICATION_GUIDELINES.md` - Communication usage
- `agents/tasks/README.md` - Task coordination
- `agents/communication/README.md` - Communication protocol
- `agents/memory/README.md` - Memory system

